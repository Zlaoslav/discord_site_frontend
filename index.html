<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>PollPi Dashboard</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --bg:#0b1020; --surface:#141b2f; --surface-soft:#1a2440; --text:#eaf0ff; --muted:#9ca9cb; --primary:#6f7bff; --border:#2a355a; --ok:#2ecc71; --danger:#ff7b7b; --shadow:0 10px 30px rgba(0,0,0,.35); }
    :root[data-theme="light"] { --bg:#f4f7ff; --surface:#ffffff; --surface-soft:#f2f5ff; --text:#0d1733; --muted:#4f5f86; --primary:#5865f2; --border:#dbe3ff; --ok:#14995e; --danger:#d93636; --shadow:0 8px 26px rgba(51,78,148,.12); }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1000px 600px at 80% -20%, rgba(88,101,242,.08), transparent),var(--bg);color:var(--text);min-height:100vh}

    .topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:12px;padding:12px 18px;backdrop-filter:blur(6px);background:color-mix(in srgb,var(--bg) 82%,transparent);border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:10px;margin-right:auto}
    .brand img{width:32px;height:32px;border-radius:8px}
    .brand .title{font-weight:800;letter-spacing:.6px}
    .nav-center{margin:auto;text-align:center}
    .user-area{display:flex;align-items:center;gap:10px;margin-left:auto}
    .user-name{font-weight:700;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .avatar{width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:var(--surface-soft);object-fit:cover}

    .button{border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600;color:var(--text);background:var(--surface);transition:.12s}
    .button:hover{transform:translateY(-1px)}
    .button-primary{background:var(--primary);border-color:transparent;color:#fff}
    .button-danger{background:color-mix(in srgb,var(--danger) 12%,var(--surface));border-color:color-mix(in srgb,var(--danger) 40%,var(--border))}
    .button-invite{background:var(--ok);border-color:transparent;color:#04210a}
    .button-disabled{opacity:.5;cursor:not-allowed}

    .layout{max-width:1100px;margin:26px auto;padding:0 14px 40px}
    .title{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted);margin:0}

    .grid{display:grid;gap:14px;margin-top:18px}
    .guild-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{border:1px solid var(--border);border-radius:14px;background:var(--surface);box-shadow:var(--shadow);padding:14px}
    .guild-card{display:flex;flex-direction:column;gap:8px}
    .guild-card .g-head{display:flex;gap:12px;align-items:center}
    .guild-card h3{margin:0;font-size:18px}
    .guild-meta{color:var(--muted);font-size:13px;margin:0}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;padding:6px 8px;border-radius:999px;background:var(--surface-soft);border:1px solid var(--border);color:var(--muted)}

    .controls-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .search{flex:1;display:flex;gap:8px;align-items:center}
    .search input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text)}
    .small-muted{color:var(--muted);font-size:13px}

    .center-card{max-width:720px;margin:80px auto;text-align:center}
    .login-hero{border-radius:16px;padding:32px;background:linear-gradient(180deg,color-mix(in srgb,var(--surface) 86%,transparent),var(--surface));border:1px solid var(--border);box-shadow:var(--shadow)}
    .login-hero h1{margin:0 0 10px}
    .login-hero p.lead{margin:0 0 20px;color:var(--muted)}

    .panel{display:grid;grid-template-columns:260px 1fr;gap:14px;margin-top:18px}
    .side{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--surface-soft)}
    .tab{display:block;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid var(--border);background:transparent;color:var(--text);text-align:left}
    .tab.active{background:var(--primary);color:#fff;border-color:transparent}
    .setting{border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px;background:var(--surface)}
    label{font-weight:700;display:block;margin-bottom:6px}
    input[type=text], input[type=number], select, textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text)}
    .row{display:flex;gap:8px}
    .switch{display:flex;align-items:center;gap:8px}
    .switch input{transform:scale(1.1)}
    .small{font-size:13px;color:var(--muted)}

    @media(max-width:840px){.guild-grid{grid-template-columns:1fr}.brand .title{display:none}.nav-center{display:none}.user-name{display:none}.panel{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="root"></div>

<script>
/* CONFIG */
const API_BASE = "https://pollpi.slavi.workers.dev";
const TOKEN_KEY = "pollpi_token";
const THEME_KEY = "ui_theme";
const DISCORD_INVITE_BASE = "https://discord.com/oauth2/authorize?client_id=1409084528588488727&scope=bot%20applications.commands&permissions=8";

/* SETTINGS TABS and schema for panel */
const SETTINGS_TABS = [
  { key: 'general', title: 'Общие' },
  { key: 'moderation', title: 'Модерация' },
  { key: 'fun', title: 'Развлечения' },
  { key: 'autos', title: 'Автозадачи' },
  { key: 'notifications', title: 'Уведомления' }
];

// schema: for each tab an array of controls with types
const SETTINGS_SCHEMA = {
  general: [
    { id: 'prefix', label: 'Префикс команд', type: 'text', placeholder: '!', hint: 'Текстовый префикс для команд' },
    { id: 'welcome_channel', label: 'Канал приветствий (ID)', type: 'text', placeholder: '123456789012345678' },
    { id: 'max_active_polls', label: 'Макс. одновременно активных опросов', type: 'number', min:0, max:100 }
  ],
  moderation: [
    { id: 'mod_log_channel', label: 'Канал логов модерации (ID)', type: 'text' },
    { id: 'auto_mute', label: 'Автоматически мутить при X предупреждений', type: 'number', min:0, max:50 },
    { id: 'mod_enabled', label: 'Включить модерацию', type: 'boolean' }
  ],
  fun: [
    { id: 'memes_channel', label: 'Канал мемов (ID)', type: 'text' },
    { id: 'fun_role', label: 'Роль для игр', type: 'role' },
    { id: 'joke_probability', label: 'Вероятность шутки (%)', type: 'number', min:0, max:100 }
  ],
  autos: [
    { id: 'daily_message', label: 'Текст ежедневного сообщения', type: 'text' },
    { id: 'daily_enabled', label: 'Включить ежедневные сообщения', type: 'boolean' },
    { id: 'dropdown_sample', label: 'Пример выпадающего списка', type: 'select', options: ['Вариант A','Вариант B'] }
  ],
  notifications: [
    { id: 'notify_role', label: 'Роль уведомлений', type: 'role' },
    { id: 'notify_on_join', label: 'Уведомлять при входе участника', type: 'boolean' },
    { id: 'webhook_url', label: 'Webhook URL', type: 'text' }
  ]
};

/* HELPERS */
(function grabTokenFromHash(){ try{ if(location.hash && location.hash.includes('token=')){ const params = new URLSearchParams(location.hash.slice(1)); const t = params.get('token'); if(t){ localStorage.setItem(TOKEN_KEY,t); history.replaceState(null,'', location.pathname + location.search); } } }catch(e){console.warn(e);} })();
function getToken(){ return localStorage.getItem(TOKEN_KEY); }
function getTheme(){ return localStorage.getItem(THEME_KEY) || 'dark'; }
function setTheme(theme){ document.documentElement.dataset.theme = theme; localStorage.setItem(THEME_KEY, theme); }
function escapeHtml(raw){ return String(raw||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;').replaceAll("'","&#39;"); }
function buildAvatarUrl(user){ if(!user) return 'https://cdn.discordapp.com/embed/avatars/0.png'; if(user.avatar) return `https://cdn.discordapp.com/avatars/${user.id||user.sub}/${user.avatar}.png`; let idx=0; try{ idx=(parseInt(user.discriminator||'0',10)||0)%5 }catch(e){ idx=0 } return `https://cdn.discordapp.com/embed/avatars/${idx}.png`; }

/* API */
async function apiFetch(path, opts={}){
  opts = opts || {}; opts.headers = opts.headers || {};
  const token = getToken(); if(token) opts.headers['Authorization'] = 'Bearer ' + token;
  opts.credentials = 'include';
  const url = path.startsWith('/') ? (API_BASE + path) : (API_BASE + '/' + path);
  return fetch(url, opts);
}
async function loadGuilds(){ const resp = await apiFetch('/guilds'); if(!resp.ok){ let hint=''; try{ hint = await resp.json(); }catch(e){} throw { status: resp.status, hint }; } const data = await resp.json(); return Array.isArray(data.guilds) ? data.guilds : (Array.isArray(data)?data:[]); }
async function initAuth(){ const resp = await apiFetch('/me'); if(!resp.ok) return { logged:false }; return resp.json(); }
async function sendSetting(guildId, tabKey, settingId, value){ const payload = { guildId, tab: tabKey, settingId, value }; try{ const r = await apiFetch('/action',{ method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) }); return r; }catch(e){ throw e; } }

/* RENDER: topbar */
function topBar(user){ const avatarUrl = buildAvatarUrl(user); const username = user ? escapeHtml(user.username||user.name||'User') : 'Гость'; return `
  <header class="topbar">
    <div class="brand">
      <img src="/favicon.png" alt="icon">
      <div class="title">PollPi</div>
    </div>
    <div class="nav-center" aria-hidden="true"><small class="muted">Dashboard</small></div>
    <div class="user-area">
      <img class="avatar" src="${avatarUrl}" alt="avatar">
      <div class="user-name">${username}</div>
      <button id="logoutBtn" class="button button-danger">Выйти</button>
      <button id="themeBtn" class="button">Тема</button>
    </div>
  </header>`; }

/* GUILD CARD */
function guildCard(guild){
  const icon = guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png` : 'https://cdn.discordapp.com/embed/avatars/1.png';
  const name = escapeHtml(guild.name || 'Без названия');
  const id = String(guild.id || '');
  const isAdmin = !!guild.isAdmin;
  const botPresent = !!guild.botPresent;
  const badges = [];
  if(isAdmin) badges.push('<span class="badge">Вы — админ</span>');
  if(botPresent) badges.push('<span class="badge">Бот установлен</span>');
  // Invite link
  const inviteLink = `${DISCORD_INVITE_BASE}&guild_id=${encodeURIComponent(id)}&disable_guild_select=true`;

  // decide primary action
  let actionHtml = '';
  if(isAdmin && !botPresent){
    actionHtml = `<a class="button button-invite" href="${inviteLink}" target="_blank" rel="noopener noreferrer">Пригласить</a>`;
  } else if(isAdmin && botPresent){
    actionHtml = `<button class="button button-primary" data-open-guild="${escapeHtml(id)}">Открыть панель</button>`;
  } else if(botPresent){
    actionHtml = `<button class="button" data-open-guild="${escapeHtml(id)}">Открыть (только просмотр)</button>`;
  } else {
    actionHtml = `<button class="button button-disabled">Недоступно</button>`;
  }

  return `
    <article class="card guild-card" data-guild-id="${escapeHtml(id)}">
      <div class="g-head">
        <img class="avatar" src="${icon}" alt="icon" style="width:56px;height:56px;border-radius:12px;">
        <div style="flex:1">
          <h3>${name}</h3>
          <p class="guild-meta">ID: ${escapeHtml(id)}</p>
          <div class="tags" style="margin-top:8px">${badges.join('')}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        ${actionHtml}
        <button class="button" data-copy-id="${escapeHtml(id)}">Копировать ID</button>
        ${isAdmin && !botPresent ? '' : ''}
      </div>
    </article>`;
}

/* PAGES */
function renderLoginPage(){ return `${topBar(null)}<main class="layout"><section class="center-card"><div class="login-hero card"><h1>Войти через Discord</h1><p class="lead">Подключитесь, чтобы управлять серверами и настраивать PollPi. Вход безопасен — мы используем авторизацию через Discord.</p><div style="display:flex;gap:12px;justify-content:center;margin-top:12px"><a href="${API_BASE}/login"><button class="button button-primary">Войти через Discord</button></a></div><div style="margin-top:18px;color:var(--muted);font-size:13px">Важно: после входа вы увидите список гильдий, в которых у вас есть доступ.</div></div></section></main>`; }

function renderGuildsPage(user, guilds, searchVal = ''){
  const empty = '<div class="card empty">Список гильдий пуст или недоступен.</div>';
  return `${topBar(user)}<main class="layout"><div class="controls-row"><div class="search"><input id="guildSearch" type="text" placeholder="Поиск гильдий по названию или ID..." value="${escapeHtml(searchVal||'')}" /><button id="refreshBtn" class="button">Обновить</button></div><div class="small-muted">${guilds && guilds.length ? guilds.length + ' сервер(ов)' : ''}</div></div><h1 class="title">Гильдии</h1><p class="muted">Выберите сервер для настройки PollPi.</p><section class="grid guild-grid">${guilds && guilds.length ? guilds.map(guildCard).join('') : empty}</section></main>`;
}

function renderGuildPanelPage(user, guild){
  const tabsHtml = SETTINGS_TABS.map(t=>`<button class="tab" data-tab="${t.key}">${escapeHtml(t.title)}</button>`).join('');
  return `${topBar(user)}<main class="layout"><div style="display:flex;gap:12px;align-items:center;margin-bottom:12px"><button id="backToGuilds" class="button">← Назад к гильдиям</button><h2 class="title">Панель сервера — ${escapeHtml(guild.name || guild.id)}</h2><div style="margin-left:auto;color:var(--muted)">Guild ID: ${escapeHtml(guild.id)}</div></div><div class="panel"><aside class="side"><div style="font-weight:800;margin-bottom:8px">Разделы</div>${tabsHtml}</aside><section class="card" id="panelMain"><h3>Настройки сервера</h3><p class="small muted">Тестовые вкладки с возможными типами ввода. Сохранение отправляет данные в /action (backend обязан обрабатывать).</p><div id="tabContent"></div></section></div></main>`;
}

/* EVENTS */
function attachGlobalEvents(){ document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{ localStorage.removeItem(TOKEN_KEY); try{ await fetch(API_BASE + '/logout', { credentials: 'include' }); }catch(e){} location.hash = '#/guilds'; location.reload(); }); document.getElementById('themeBtn')?.addEventListener('click', ()=>{ const current=getTheme(); setTheme(current==='dark'?'light':'dark'); document.documentElement.dataset.theme=getTheme(); }); }

function attachGuildsPageEvents(){ document.querySelectorAll('[data-copy-id]').forEach(btn=>btn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(btn.dataset.copyId); const prev = btn.textContent; btn.textContent = 'Скопировано'; setTimeout(()=>btn.textContent = prev,1200); }catch(e){ console.warn(e); } }));
  document.querySelectorAll('[data-open-guild]').forEach(btn=>btn.addEventListener('click', ()=>{ location.hash = '#/guild/' + btn.dataset.openGuild; }));
  const refresh = document.getElementById('refreshBtn'); if(refresh) refresh.addEventListener('click', ()=>renderApp(true));
  const search = document.getElementById('guildSearch'); if(search){ search.addEventListener('input', (e)=>{ sessionStorage.setItem('guild_search', e.target.value); filterGuildsOnPage(e.target.value); }); search.focus(); }
}

function attachPanelEvents(guild){
  document.getElementById('backToGuilds')?.addEventListener('click', ()=>{ location.hash = '#/guilds'; renderApp(); });
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',(e)=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); renderSettingsTab(guild, t.dataset.tab);
  }));
  // activate first tab
  const firstTab = document.querySelector('.tab'); if(firstTab){ firstTab.classList.add('active'); renderSettingsTab(guild, firstTab.dataset.tab); }
}

/* render settings tab */
function renderSettingsTab(guild, tabKey){
  const container = document.getElementById('tabContent'); if(!container) return; container.innerHTML = '';
  const schema = SETTINGS_SCHEMA[tabKey] || [];
  schema.forEach(control => {
    const el = document.createElement('div'); el.className = 'setting';
    const id = control.id;
    let inner = `<label for="${id}">${escapeHtml(control.label || id)}</label>`;
    if(control.type === 'text'){
      inner += `<input type="text" id="${id}" placeholder="${escapeHtml(control.placeholder || '')}" />`;
    } else if(control.type === 'number'){
      inner += `<input type="number" id="${id}" min="${control.min||''}" max="${control.max||''}" />`;
    } else if(control.type === 'boolean'){
      inner += `<div class="switch"><input type="checkbox" id="${id}" /><span class="small">Да / Нет</span></div>`;
    } else if(control.type === 'select'){
      inner += `<select id="${id}">` + (Array.isArray(control.options)? control.options.map(o=>`<option>${escapeHtml(o)}</option>`).join('') : '') + `</select>`;
      inner += `<div style="margin-top:8px"><input type="text" id="${id}_new_opt" placeholder="Добавить опцию..." /><button class="button" id="${id}_add">Добавить</button></div>`;
    } else if(control.type === 'member'){
      inner += `<input type="text" id="${id}" placeholder="ID участника или @nickname" />`;
    } else if(control.type === 'role'){
      inner += `<select id="${id}"><option value="">-- выбрать роль --</option></select><div style="margin-top:8px"><input type="text" id="${id}_new" placeholder="Добавить роль (имя или ID)" /><button class="button" id="${id}_add">Добавить</button></div>`;
    } else {
      inner += `<input type="text" id="${id}" />`;
    }
    inner += `<div style="display:flex;gap:8px;margin-top:10px"><button class="button button-primary" data-save-setting="${escapeHtml(id)}">Сохранить</button><div class="small muted" id="${id}_status"></div></div>`;
    el.innerHTML = inner; container.appendChild(el);

    // attach dynamic handlers for select/role add
    if(control.type === 'select'){
      setTimeout(()=>{
        document.getElementById(`${id}_add`)?.addEventListener('click', ()=>{
          const val = document.getElementById(`${id}_new_opt`).value.trim(); if(!val) return; const sel = document.getElementById(id); const op = document.createElement('option'); op.textContent = val; sel.appendChild(op); document.getElementById(`${id}_new_opt`).value = '';
        });
      },0);
    }
    if(control.type === 'role'){
      setTimeout(()=>{
        document.getElementById(`${id}_add`)?.addEventListener('click', ()=>{
          const val = document.getElementById(`${id}_new`).value.trim(); if(!val) return; const sel = document.getElementById(id); const op = document.createElement('option'); op.textContent = val; op.value = val; sel.appendChild(op); document.getElementById(`${id}_new`).value = '';
        });
      },0);
    }
    // save handler
    setTimeout(()=>{
      document.querySelector(`[data-save-setting="${escapeHtml(id)}"]`)?.addEventListener('click', async ()=>{
        try{
          const saveBtn = document.querySelector(`[data-save-setting="${escapeHtml(id)}"]`);
          saveBtn.disabled = true; saveBtn.textContent = 'Сохраняю...';
          let value;
          if(control.type === 'boolean') value = document.getElementById(id).checked;
          else if(control.type === 'select') value = Array.from(document.getElementById(id).options).map(o=>o.value||o.textContent);
          else value = document.getElementById(id).value;
          await sendSetting(guild.id, tabKey, id, value);
          document.getElementById(`${id}_status`).textContent = 'Сохранено';
          setTimeout(()=>{ if(document.getElementById(`${id}_status`)) document.getElementById(`${id}_status`).textContent = ''; },2000);
          saveBtn.disabled = false; saveBtn.textContent = 'Сохранить';
        }catch(e){ console.warn(e); if(document.getElementById(`${id}_status`)) document.getElementById(`${id}_status`).textContent = 'Ошибка'; const saveBtn = document.querySelector(`[data-save-setting="${escapeHtml(id)}"]`); if(saveBtn){ saveBtn.disabled=false; saveBtn.textContent='Сохранить'; } }
      });
    },0);
  });
}

/* search filter */
function filterGuildsOnPage(q){ q = (q||'').toLowerCase().trim(); document.querySelectorAll('.guild-card').forEach(card=>{ const title = (card.querySelector('h3')?.textContent || '').toLowerCase(); const meta = (card.querySelector('.guild-meta')?.textContent || '').toLowerCase(); const gid = (card.dataset.guildId || '').toLowerCase(); if(!q || title.includes(q) || meta.includes(q) || gid.includes(q)) card.style.display = ''; else card.style.display = 'none'; }); }

/* MAIN renderApp */
async function renderApp(forceReload = false){ setTheme(getTheme()); const root = document.getElementById('root'); try{ const auth = await initAuth(); if(!auth.logged){ root.innerHTML = renderLoginPage(); attachGlobalEvents(); return; }

    const hash = (location.hash || '#/guilds').replace('#',''); const [_, route, guildId] = hash.split('/');

    if(route === 'guild' && guildId){
      // load guilds to find guild info and permissions
      let guilds = [];
      try{ guilds = await loadGuilds(); }catch(err){ console.warn('loadGuilds failed',err); location.hash = '#/guilds'; renderApp(); return; }
      const guild = guilds.find(g=>String(g.id) === String(guildId));
      if(!guild || !guild.botPresent || !guild.isAdmin){
        // redirect to guilds if not allowed or bot not present
        alert('У вас нет доступа к настройкам этого сервера или бот не установлен.');
        location.hash = '#/guilds'; renderApp(); return;
      }
      root.innerHTML = renderGuildPanelPage(auth.user, guild);
      attachGlobalEvents(); attachPanelEvents(guild);
      return;
    }

    // default: guilds page
    root.innerHTML = `${topBar(auth.user)}<main class="layout"><div class="controls-row"><div class="search"><input id="guildSearch" type="text" placeholder="Поиск гильдий по названию или ID..." value="${escapeHtml(sessionStorage.getItem('guild_search')||'')}" /><button id="refreshBtn" class="button">Обновить</button></div><div class="small-muted">Загрузка...</div></div><section class="grid guild-grid"><div class="card empty">Загрузка...</div></section></main>`;
    document.getElementById('refreshBtn')?.addEventListener('click', ()=>renderApp(true)); document.getElementById('guildSearch')?.addEventListener('input', (e)=>{ sessionStorage.setItem('guild_search', e.target.value); }); attachGlobalEvents();

    // fetch guilds
    let guilds = [];
    try{ guilds = await loadGuilds(); }catch(err){ const hint = err.hint || {}; const hintText = hint && hint.reason === 'no_oauth_tokens' ? 'Требуется повторная авторизация — нажмите Войти' : (typeof hint === 'object' ? JSON.stringify(hint) : String(hint)); root.innerHTML = `${topBar(auth.user)}<main class="layout"><div class="controls-row"><div class="search"><input id="guildSearch" type="text" placeholder="Поиск гильдий по названию или ID..." value="${escapeHtml(sessionStorage.getItem('guild_search')||'')}" /><button id="refreshBtn" class="button">Обновить</button></div></div><div class="card" style="color:var(--danger);margin-bottom:12px">Ошибка загрузки гильдий: ${escapeHtml(err.status + ' ' + hintText)}<div style="margin-top:8px"><a href="${API_BASE}/login"><button class="button button-primary">Переавторизоваться</button></a></div></div></main>`; attachGlobalEvents(); document.getElementById('refreshBtn')?.addEventListener('click', ()=>renderApp(true)); return; }

    const searchVal = sessionStorage.getItem('guild_search') || '';
    root.innerHTML = renderGuildsPage(auth.user, guilds, searchVal);
    attachGlobalEvents(); attachGuildsPageEvents(); if(searchVal) filterGuildsOnPage(searchVal);

  }catch(e){ root.innerHTML = `<main class="layout"><section class="card"><h2>Ошибка</h2><pre>${escapeHtml(e && e.message ? e.message : String(e))}</pre></section></main>`; }
}

window.addEventListener('hashchange', ()=>renderApp()); window.addEventListener('storage', ()=> setTheme(getTheme())); renderApp();

</script>
</body>
</html>