<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>[dev] PollPi Dashboard</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* сохранён твой стиль (копия) */
    :root { --bg:#0b1020; --surface:#141b2f; --surface-soft:#1a2440; --text:#eaf0ff; --muted:#9ca9cb; --primary:#6f7bff; --border:#2a355a; --ok:#67d39f; --danger:#ff7b7b; --shadow:0 10px 30px rgba(0,0,0,.35); }
    :root[data-theme="light"] { --bg:#f4f7ff; --surface:#ffffff; --surface-soft:#f2f5ff; --text:#0d1733; --muted:#4f5f86; --primary:#5865f2; --border:#dbe3ff; --ok:#14995e; --danger:#d93636; --shadow:0 8px 26px rgba(51,78,148,.12); }
    * { box-sizing: border-box; }
    body { margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:radial-gradient(1000px 600px at 80% -20%, rgba(88,101,242,.2), transparent),var(--bg); color:var(--text); min-height:100vh; }
    .topbar { position:sticky; top:0; z-index:20; display:flex; justify-content:space-between; align-items:center; gap:16px; padding:14px 18px; backdrop-filter:blur(8px); background:color-mix(in srgb, var(--bg) 80%, transparent); border-bottom:1px solid var(--border); }
    .user-block { display:flex; align-items:center; gap:10px; min-width:0; }
    .avatar { width:34px; height:34px; border-radius:999px; border:1px solid var(--border); background:var(--surface-soft); object-fit:cover; }
    .user-name { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; }
    .button { border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:600; color:var(--text); background:var(--surface); transition:.2s; }
    .button:hover { transform:translateY(-1px); }
    .button-primary { background:var(--primary); border-color:transparent; color:#fff; }
    .button-danger { background:color-mix(in srgb, var(--danger) 16%, var(--surface)); border-color:color-mix(in srgb, var(--danger) 50%, var(--border)); }
    .layout { max-width:1100px; margin:26px auto; padding:0 14px 40px; }
    .title { margin:0 0 6px; }
    .muted { color:var(--muted); margin:0; }
    .grid { display:grid; gap:14px; margin-top:18px; }
    .guild-grid { grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); }
    .card { border:1px solid var(--border); border-radius:16px; background:var(--surface); box-shadow:var(--shadow); padding:14px; }
    .guild-card h3 { margin:10px 0 6px; }
    .guild-meta { color:var(--muted); font-size:14px; }
    .panel-shell { display:grid; grid-template-columns:240px 1fr; gap:14px; margin-top:18px; }
    .tabs { display:flex; flex-direction:column; gap:8px; }
    .tab { text-align:left; width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--surface-soft); color:var(--text); cursor:pointer; font-weight:600; }
    .tab.active { background:var(--primary); border-color:transparent; color:#fff; }
    .section-title { margin-top:0; margin-bottom:12px; }
    .setting { display:grid; grid-template-columns:1fr; gap:8px; margin-bottom:12px; padding:12px; border:1px solid var(--border); border-radius:12px; background:var(--surface-soft); }
    label { font-weight:600; }
    input[type="text"], input[type="number"], select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text); }
    textarea { resize:vertical; min-height:90px; }
    .switch { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .status { margin-top:10px; font-size:14px; color:var(--ok); min-height:20px; }
    .empty { text-align:center; color:var(--muted); padding:30px 12px; }
    .controls-row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .search { flex:1; display:flex; gap:8px; align-items:center; }
    .search input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text); }
    .small-muted { color:var(--muted); font-size:13px; margin-left:8px; }
    @media (max-width:840px) { .panel-shell { grid-template-columns:1fr; } .topbar { flex-wrap:wrap; } }
  </style>
</head>
<body>
  <div id="root"></div>

<script>
/* CONFIG */
const API_BASE = "https://pollpi.slavi.workers.dev";
const TOKEN_KEY = "pollpi_token";
const THEME_KEY = "ui_theme";

/* SETTINGS (unchanged) */
const SETTINGS_TABS = [ /* same as before, omitted for brevity in this excerpt - include the same array as previously */ ];
/* For brevity in this message I assume SETTINGS_TABS is identical to previous file - include the array exactly as before in your actual file. */

/* HELPERS */
(function grabTokenFromHash() {
  try {
    if (location.hash && location.hash.includes("token=")) {
      const params = new URLSearchParams(location.hash.slice(1));
      const token = params.get("token");
      if (token) {
        localStorage.setItem(TOKEN_KEY, token);
        history.replaceState(null, "", location.pathname + location.search);
      }
    }
  } catch (e) { console.warn("token grab error", e); }
})();
function getToken() { return localStorage.getItem(TOKEN_KEY); }
function getTheme() { return localStorage.getItem(THEME_KEY) || "dark"; }
function setTheme(theme) { document.documentElement.dataset.theme = theme; localStorage.setItem(THEME_KEY, theme); }
function escapeHtml(raw) { return String(raw||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
function buildAvatarUrl(user) {
  if (!user) return "https://cdn.discordapp.com/embed/avatars/0.png";
  if (user.avatar) return `https://cdn.discordapp.com/avatars/${user.sub}/${user.avatar}.png`;
  let idx=0; try{ idx=(parseInt(user.discriminator||"0",10)||0)%5 }catch(e){idx=0}
  return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
}

/* API */
async function apiFetch(path, opts={}) {
  opts = opts || {}; opts.headers = opts.headers || {};
  const token = getToken(); if (token) opts.headers["Authorization"]="Bearer "+token;
  opts.credentials = "include";
  const url = path.startsWith("/") ? (API_BASE + path) : (API_BASE + "/" + path);
  return fetch(url, opts);
}
async function sendSetting(guildId, tabKey, settingId, value) {
  const payload = { guildId, tab: tabKey, settingId, value };
  return apiFetch("/action", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
}

/* RENDER helpers (same as earlier) */
function topBar(user) {
  const avatarUrl = buildAvatarUrl(user);
  const name = user ? `${escapeHtml(user.username)}#${escapeHtml(user.discriminator||"0000")}` : "Гость";
  return `
    <header class="topbar">
      <div class="user-block">
        <button id="logoutBtn" class="button button-danger">Выйти</button>
        <img class="avatar" src="${avatarUrl}" alt="avatar">
        <span class="user-name">${name}</span>
      </div>
      <div>
        <button id="themeBtn" class="button">Сменить тему</button>
      </div>
    </header>
  `;
}
function renderControl(item, state) { /* same as before — copy exact implementation from previous file */ }
function guildCard(guild) {
  const icon = guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png` : "https://cdn.discordapp.com/embed/avatars/1.png";
  const name = escapeHtml(guild.name || "Без названия");
  const id = String(guild.id || "");
  const extras = []; if (guild.isAdmin) extras.push("Вы — админ"); if (guild.botPresent) extras.push("Бот в сервере");
  const meta = extras.length ? extras.join(" • ") : `ID: ${escapeHtml(id)}`;
  return `
    <article class="card guild-card">
      <img class="avatar" src="${icon}" alt="guild icon">
      <h3>${name}</h3>
      <p class="guild-meta">${meta}</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="button button-primary" data-open-guild="${escapeHtml(id)}">Открыть панель</button>
        <button class="button" data-copy-id="${escapeHtml(id)}">Копировать ID</button>
      </div>
    </article>
  `;
}

/* UI: search + refresh + guilds list rendering */
function renderGuildsPage(user, guilds, searchVal = "", loading = false, errMsg = "") {
  const empty = '<div class="card empty">Список гильдий пуст или недоступен.</div>';
  return `
    ${topBar(user)}
    <main class="layout">
      <div class="controls-row">
        <div class="search">
          <input id="guildSearch" type="text" placeholder="Поиск гильдий по названию или ID..." value="${escapeHtml(searchVal||"")}" />
          <button id="refreshBtn" class="button">Обновить</button>
        </div>
        <div class="small-muted">${loading ? "Загрузка..." : ""}</div>
      </div>

      ${errMsg ? `<div class="card" style="margin-bottom:12px;color:var(--danger)">${escapeHtml(errMsg)}</div>` : ""}
      <h1 class="title">Выбор гильдии</h1>
      <p class="muted">Выберите сервер для настройки бота.</p>
      <section class="grid guild-grid">${guilds.length ? guilds.map(guildCard).join("") : empty}</section>
    </main>
  `;
}

/* attach events (search + refresh + copy + open) */
function attachGlobalEvents() {
  document.getElementById("logoutBtn")?.addEventListener("click", async () => {
    localStorage.removeItem(TOKEN_KEY);
    try { await fetch(API_BASE + "/logout", { credentials: "include" }); } catch (_) {}
    location.hash = "#/guilds"; location.reload();
  });
  document.getElementById("themeBtn")?.addEventListener("click", ()=>{ const current=getTheme(); setTheme(current==="dark"?"light":"dark"); document.documentElement.dataset.theme=getTheme(); });
}
function attachGuildPageEvents() {
  document.querySelectorAll("[data-open-guild]").forEach(btn=>btn.addEventListener("click", ()=>{ location.hash = "#/guild/" + btn.dataset.openGuild; }));
  document.querySelectorAll("[data-copy-id]").forEach(btn=>btn.addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(btn.dataset.copyId); const prev=btn.textContent; btn.textContent="Скопировано"; setTimeout(()=>btn.textContent=prev,1200);}catch(e){console.warn(e)} }));
  const refresh = document.getElementById("refreshBtn"); if (refresh) refresh.addEventListener("click", ()=>renderApp(true));
  const search = document.getElementById("guildSearch"); if (search) {
    search.addEventListener("input", (e)=>{ sessionStorage.setItem("guild_search", e.target.value); filterGuildsOnPage(e.target.value); });
    search.focus();
  }
}

/* helper to filter DOM cards by name/id */
function filterGuildsOnPage(q) {
  q = (q||"").toLowerCase().trim();
  document.querySelectorAll(".guild-card").forEach(card=>{
    const title = (card.querySelector("h3")?.textContent || "").toLowerCase();
    const meta = (card.querySelector(".guild-meta")?.textContent || "").toLowerCase();
    if (!q || title.includes(q) || meta.includes(q)) card.style.display = "";
    else card.style.display = "none";
  });
}

/* panel event bindings (same as before) */
function attachPanelEvents(guildId, selectedTab, state) { /* same as before - copy exact implementation */ }

/* BOOTSTRAP */
async function initAuth() {
  const resp = await apiFetch("/me");
  if (!resp.ok) return { logged:false };
  return resp.json();
}
async function loadGuilds() {
  const resp = await apiFetch("/guilds");
  if (!resp.ok) {
    // try to read body for helpful hint
    let hint = "";
    try { hint = await resp.json(); } catch(e){}
    throw { status: resp.status, hint };
  }
  const data = await resp.json();
  return Array.isArray(data.guilds) ? data.guilds : (Array.isArray(data) ? data : []);
}

/* MAIN renderApp with refresh flag */
async function renderApp(forceReload = false) {
  setTheme(getTheme());
  const root = document.getElementById("root");
  try {
    const auth = await initAuth();
    if (!auth.logged) {
      root.innerHTML = `<main class="layout"><section class="card" style="max-width:520px;margin:60px auto;text-align:center"><h1>Войти через Discord</h1><p class="muted">Нажмите, чтобы авторизоваться и управлять гильдиями.</p><a href="${API_BASE}/login"><button class="button button-primary">Войти через Discord</button></a></section></main>`;
      return;
    }

    const hash = (location.hash || "#/guilds").replace("#","");
    const [_, route, guildId] = hash.split("/");

    if (route === "guild" && guildId) {
      const selectedTab = sessionStorage.getItem(`tab_${guildId}`) || SETTINGS_TABS[0].key;
      const state = JSON.parse(sessionStorage.getItem(`state_${guildId}`) || "{}");
      root.innerHTML = renderGuildPanelPage(auth.user, guildId, selectedTab, state);
      attachGlobalEvents(); attachPanelEvents(guildId, selectedTab, state);
      sessionStorage.setItem(`state_${guildId}`, JSON.stringify(state));
      return;
    }

    // show loading UI while fetching guilds
    root.innerHTML = `${topBar(auth.user)}<main class="layout"><div class="controls-row"><div class="search"><input id="guildSearch" type="text" placeholder="Поиск..." value="${escapeHtml(sessionStorage.getItem("guild_search")||"")}" /><button id="refreshBtn" class="button">Обновить</button></div><div class="small-muted">Загрузка...</div></div><section class="grid guild-grid"><div class="card empty">Загрузка...</div></section></main>`;
    // attach temp events
    document.getElementById("refreshBtn")?.addEventListener("click", ()=>renderApp(true));
    document.getElementById("guildSearch")?.addEventListener("input", (e)=>{ sessionStorage.setItem("guild_search", e.target.value); });

    // fetch guilds
    let guilds = [];
    try {
      guilds = await loadGuilds();
    } catch (err) {
      // render error with reauth hint or retry
      const hint = err.hint || {};
      const hintText = hint && hint.reason === "no_oauth_tokens" ? "Требуется повторная авторизация — нажмите Войти" : (typeof hint === "object" ? JSON.stringify(hint) : String(hint));
      root.innerHTML = `${topBar(auth.user)}<main class="layout"><div class="controls-row"><div class="search"><input id="guildSearch" type="text" placeholder="Поиск..." value="${escapeHtml(sessionStorage.getItem("guild_search")||"")}" /><button id="refreshBtn" class="button">Обновить</button></div></div><div class="card" style="color:var(--danger);margin-bottom:12px">Ошибка загрузки гильдий: ${escapeHtml(err.status + " " + hintText)}<div style="margin-top:8px"><a href="${API_BASE}/login"><button class="button button-primary">Переавторизоваться</button></a></div></div></main>`;
      attachGlobalEvents(); document.getElementById("refreshBtn")?.addEventListener("click", ()=>renderApp(true));
      return;
    }

    const searchVal = sessionStorage.getItem("guild_search") || "";
    root.innerHTML = renderGuildsPage(auth.user, guilds, searchVal, false, "");
    attachGlobalEvents(); attachGuildPageEvents();

    // apply search filter (if any)
    if (searchVal) filterGuildsOnPage(searchVal);

  } catch (e) {
    root.innerHTML = `<main class="layout"><section class="card"><h2>Ошибка</h2><pre>${escapeHtml(e && e.message ? e.message : String(e))}</pre></section></main>`;
  }
}

/* INIT */
window.addEventListener("hashchange", ()=>renderApp());
window.addEventListener("storage", ()=> setTheme(getTheme()));
renderApp();

</script>
</body>
</html>
