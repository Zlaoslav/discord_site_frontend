<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>PollPi ‚Äî Guild Settings</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020; --surface:#141b2f; --surface-soft:#1a2440; --text:#eaf0ff;
      --muted:#9ca9cb; --primary:#6f7bff; --border:#2a355a; --ok:#2ecc71;
      --danger:#ff7b7b; --shadow:0 10px 30px rgba(0,0,0,.35);
      --accent-on:#67d39f; --accent-off:#6b7280;
      --glass: rgba(255,255,255,0.02);
    }
    :root[data-theme="light"]{
      --bg:#f4f7ff; --surface:#fff; --surface-soft:#f2f5ff; --text:#0d1733;
      --muted:#4f5f86; --primary:#5865f2; --border:#dbe3ff; --ok:#14995e; --danger:#d93636;
      --shadow:0 8px 26px rgba(51,78,148,.12); --accent-on:#14995e; --accent-off:#9aa4c4; --glass: rgba(0,0,0,0.02);
    }

    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1000px 600px at 80% -20%, rgba(88,101,242,.08), transparent), var(--bg);
      color:var(--text);
    }

    /* Topbar */
    .topbar{ position:sticky; top:0; z-index:40; display:flex; gap:12px; align-items:center; padding:12px 18px;
      background: color-mix(in srgb, var(--bg) 82%, transparent); border-bottom:1px solid var(--border); }
    .brand{ display:flex; gap:10px; align-items:center }
    .brand img{ width:34px; height:34px; border-radius:8px; }
    .brand .title{ font-weight:800; letter-spacing:.6px; font-size:16px }
    .user-area{ margin-left:auto; display:flex; gap:8px; align-items:center }
    .avatar{ width:36px; height:36px; border-radius:999px; border:1px solid var(--border); background:var(--surface-soft); object-fit:cover }
    .button{ border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer; background:var(--surface); color:var(--text); font-weight:600; transition:.12s }
    .button:hover{ transform:translateY(-1px) }
    .button-primary{ background:var(--primary); border-color:transparent; color:#fff }
    .button-danger{ background:color-mix(in srgb,var(--danger) 12%,var(--surface)); border-color:color-mix(in srgb,var(--danger) 40%,var(--border)) }
    .button-ghost{ background:transparent; border:1px solid transparent }

    .layout{ max-width:1100px; margin:26px auto; padding:0 14px 60px; }

    .controls-row{ display:flex; gap:8px; align-items:center; margin-bottom:10px }
    .search{ flex:1; display:flex; gap:8px; align-items:center }
    .search input{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text) }
    .small-muted{ color:var(--muted); font-size:13px }

    /* Guild grid */
    .grid{ display:grid; gap:14px; margin-top:18px }
    .guild-grid{ grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .card{ border:1px solid var(--border); border-radius:14px; background:var(--surface); box-shadow:var(--shadow); padding:14px }
    .guild-card{ display:flex; flex-direction:column; gap:10px }
    .g-head{ display:flex; gap:12px; align-items:center }
    .g-avatar{ width:56px; height:56px; border-radius:12px; object-fit:cover; border:1px solid var(--border) }
    .guild-meta{ color:var(--muted); font-size:13px; margin:0 }
    

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    .guild-title{
      margin:0;
      font-weight:600;
    }

    /* –ë–ª–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ */
    .member-info{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:10px;
      font-size:14px;
      font-weight:500;
    }
    /* –û–Ω–ª–∞–π–Ω (–±–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω) */
    .member-info.online{
      color:#d1f7e3;
    }

    /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–µ–ª—ë–Ω–∞—è —Ç–æ—á–∫–∞ */
    .status-dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:#22c55e;
      position:relative;
    }

    .status-dot::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:50%;
      background:#22c55e;
      animation:pulse 1.8s infinite;
      opacity:0.6;
    }

    @keyframes pulse{
      0%{ transform:scale(1); opacity:0.6; }
      70%{ transform:scale(2.5); opacity:0; }
      100%{ opacity:0; }
    }

/* –û—Ñ—Ñ–ª–∞–π–Ω (–±–æ—Ç–∞ –Ω–µ—Ç) */
    .member-info.offline{
      color:#9ca3af;
    }

    .offline-dot{
      background:#6b7280;
    }

    .offline-dot::after{
      display:none;
    }
    /* –ö–Ω–æ–ø–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ */
    .action-btn{
      font-size:14px;
      padding:8px 14px;
      font-weight:500;
    }

    /* –ó–µ–ª—ë–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å */
    .button-success{
      background:#22c55e;
      border:1px solid #16a34a;
      color:white;
    }

    .button-success:hover{
      background:#16a34a;
    }

    /* –õ–µ–π–∞—É—Ç –¥–µ–π—Å—Ç–≤–∏–π */
    .card-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:14px;
    }

    .left-actions{
      display:flex;
      gap:10px;
    }


    /* Panel */
    .panel{ display:grid; grid-template-columns:280px 1fr; gap:14px; margin-top:18px }
    .side{ border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--surface-soft) }
    .tab{ display:block; padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer }
    .tab.active{ background:var(--primary); border-color:transparent; color:#fff }
    .card-surface{ border:1px solid var(--border); border-radius:12px; padding:14px; background:var(--surface) }

    .setting{ border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:12px; background:var(--surface) }
    label{ display:block; font-weight:700; margin-bottom:8px }
    .row{ display:flex; gap:8px; align-items:center }

    /* fancy toggle */
    .toggle{
      width:52px; height:30px; border-radius:20px; position:relative; display:inline-block; background:var(--accent-off);
      border:1px solid var(--border); transition:all .18s; cursor:pointer;
    }
    .toggle.on{ background: linear-gradient(90deg,var(--primary), var(--accent-on)); box-shadow: 0 6px 18px rgba(0,0,0,.35); }
    .toggle .knob{ position:absolute; left:4px; top:4px; width:22px; height:22px; border-radius:50%; background:#fff; transition:all .18s }
    .toggle.on .knob{ transform:translateX(22px) }

    .small{ font-size:13px; color:var(--muted) }
    .muted{ color:var(--muted) }

    /* bottom drawer modal */
    .drawer-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:flex-end; justify-content:center; z-index:80 }
    .drawer{ width:100%; max-width:900px; border-radius:12px 12px 0 0; background:var(--surface); padding:18px; border-top:1px solid var(--border); box-shadow:0 -20px 60px rgba(0,0,0,.6) }
    .drawer.show{ display:block }
    .drawer-header{ display:flex; align-items:center; gap:12px; margin-bottom:8px }
    .drawer-body{ max-height:48vh; overflow:auto; margin-bottom:12px }
    .drawer-footer{ display:flex; gap:8px; justify-content:flex-end; align-items:center }

    /* spinner */
    .spinner{ width:18px; height:18px; border-radius:50%; border:3px solid rgba(255,255,255,0.12); border-top-color:var(--text); animation:spin .9s linear infinite; display:inline-block }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* nice inputs for selects with search */
    .select-search{ position:relative }
    .select-search input{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--text) }

    .list-dropdown{ border:1px solid var(--border); border-radius:8px; margin-top:8px; max-height:220px; overflow:auto; background:var(--surface-soft) }
    .list-item{ padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.02); cursor:pointer }
    .list-item:hover{ background: color-mix(in srgb, var(--primary) 8%, transparent) }

    /* slider */
    .slider-row{ display:flex; align-items:center; gap:12px }
    input[type=range]{ width:100% }

    /* rewards table */
    .rewards-table{ width:100%; border-collapse:collapse }
    .rewards-table th, .rewards-table td{ padding:8px; border-bottom:1px dashed rgba(255,255,255,0.03); text-align:left }
    .rewards-actions{ display:flex; gap:8px; align-items:center }

    @media(max-width:840px){
      .panel{ grid-template-columns:1fr }
      .guild-grid{ grid-template-columns:1fr }
      .layout{ padding-bottom:100px }
    }
  </style>
</head>
<body>
  <div id="root"></div>

<script>
/* ========== CONFIG ========== */
const API_BASE = "https://pollpi.slavi.workers.dev";
const TOKEN_KEY = "pollpi_token";
const THEME_KEY = "ui_theme";
const CLIENT_ID = "1409084528588488727"; // used only for invite link

/* ========== HELPERS ========== */
function getToken(){ return localStorage.getItem(TOKEN_KEY); }
function getTheme(){ return localStorage.getItem(THEME_KEY) || "dark"; }
function setTheme(t){ document.documentElement.setAttribute("data-theme", t); localStorage.setItem(THEME_KEY, t); }

(function grabTokenFromHash(){
  try{
    if(location.hash && location.hash.includes("token=")){
      const params = new URLSearchParams(location.hash.slice(1));
      const t = params.get("token");
      if(t){ localStorage.setItem(TOKEN_KEY, t); history.replaceState(null, "", location.pathname + location.search); }
    }
  }catch(e){ console.warn("token grab error", e); }
})();

function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }

/* API utility ‚Äî ensures credentials included for cookies + Authorization header */
async function apiFetch(path, opts = {}){
  opts = opts || {}; opts.headers = opts.headers || {};
  const token = getToken();
  if(token) opts.headers["Authorization"] = "Bearer " + token;
  opts.credentials = "include";
  const url = path.startsWith("/") ? (API_BASE + path) : (API_BASE + "/" + path);
  return fetch(url, opts);
}

/* convenient POST action sender */
async function postActions(guildId, actions){
  const payload = { guildId: String(guildId), guild_id: String(guildId), actions };
  const resp = await apiFetch("/action", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  return resp;
}

/* ========== UI: Topbar & Pages ========== */
function topBar(user){
  const name = user ? (escapeHtml(user.username || user.name || "User") + (user.discriminator ? ("#" + escapeHtml(user.discriminator)) : "")) : "–ì–æ—Å—Ç—å";
  const avatar = user && user.avatar ? `https://cdn.discordapp.com/avatars/${user.sub||user.id}/${user.avatar}.png` : "https://cdn.discordapp.com/embed/avatars/0.png";
  return `
    <header class="topbar">
      <div class="brand"><img src="favicon.ico" alt="icon"><div class="title">PollPi</div></div>
      <div class="controls-row" style="margin-left:12px;align-items:center"></div>
      <div class="user-area">
        ${user ? `<img class="avatar" src="${avatar}" alt="avatar"><div class="small-muted">${name}</div><button id="logoutBtn" class="button button-danger">–í—ã–π—Ç–∏</button>` : `<button id="loginBtn" class="button button-primary">–í–æ–π—Ç–∏</button>`}
        <button id="themeBtn" class="button">${getTheme()==='dark' ? 'üåô' : '‚òÄÔ∏è'}</button>
      </div>
    </header>
  `;
}

/* Guild card */
function guildCard(g){
  const icon = g.icon 
    ? `https://cdn.discordapp.com/icons/${g.id}/${g.icon}.png`
    : "https://cdn.discordapp.com/embed/avatars/1.png";

  const id = String(g.id || "");
  const name = escapeHtml(g.name || id);
  const hasBot = g.botPresent;
  const memberCount = g.memberCount ?? 0;

  // –ë–ª–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  const memberInfo = hasBot
    ? `
      <div class="member-info online">
        <span class="status-dot"></span>
        <span class="member-count">${memberCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
      </div>
    `
    : `
      <div class="member-info offline">
        <span class="status-dot offline-dot"></span>
        <span class="member-count">–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</span>
      </div>
    `;

  // –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞
  let primaryAction = '';

  if(g.isAdmin && hasBot){
    primaryAction = `
      <button class="button button-primary action-btn" data-open-guild="${escapeHtml(id)}">
        –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
      </button>`;
  } 
  else if(g.isAdmin && !hasBot){
    const invite = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&scope=bot%20applications.commands&permissions=8&guild_id=${encodeURIComponent(id)}&disable_guild_select=true`;
    primaryAction = `
      <a class="button button-success action-btn"
         href="${invite}"
         target="_blank"
         rel="noopener noreferrer">
        –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –±–æ—Ç–∞
      </a>`;
  } 
  else if(hasBot){
    primaryAction = `
      <button class="button action-btn" data-open-guild="${escapeHtml(id)}">
        –û—Ç–∫—Ä—ã—Ç—å (–ø—Ä–æ—Å–º–æ—Ç—Ä)
      </button>`;
  } 
  else {
    primaryAction = `
      <button class="button button-ghost button-disabled action-btn">
        –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ
      </button>`;
  }

  return `
    <article class="card guild-card" data-guild-id="${escapeHtml(id)}">
      <div class="g-head">
        <img class="g-avatar" src="${icon}" alt="icon">
        <div style="flex:1">
          <h3 class="guild-title">${name}</h3>
          <p class="guild-meta">ID: ${escapeHtml(id)}</p>
          ${memberInfo}
        </div>
      </div>

      <div class="card-actions">
        <div class="left-actions">
          ${primaryAction}
          <button class="button action-btn" data-copy-id="${escapeHtml(id)}">
            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID
          </button>
        </div>
        <div class="small-muted">${g.permissions ?? ""}</div>
      </div>
    </article>
  `;
}

/* ========= Field creation helper =========
   createField(config)
   config: {
     id, label, description, type: 'text'|'number'|'boolean'|'select'|'member'|'role'|'channel'|'slider'|'rewards', 
     options: [], min, max, step, placeholder, singleChannelAllowed (bool), separateSetter (bool)
   }
   returns DOM element (div.setting)
*/
function createField(config, guild){
  const id = config.id;
  const wrapper = document.createElement("div");
  wrapper.className = "setting";
  let inner = `<label for="${id}">${escapeHtml(config.label || id)}</label>`;
  if(config.description) inner += `<div class="small-muted" style="margin-bottom:8px">${escapeHtml(config.description)}</div>`;

  if(config.type === "text"){
    inner += `<input type="text" id="${id}" placeholder="${escapeHtml(config.placeholder||"")}" />`;
  } else if(config.type === "number"){
    inner += `<input type="number" id="${id}" min="${config.min||""}" max="${config.max||""}" step="${config.step||"1"}" />`;
  } else if(config.type === "boolean"){
    inner += `<div class="row"><div id="${id}_toggle" class="toggle" role="switch" aria-checked="false"><span class="knob"></span></div><div class="small-muted">${escapeHtml(config.hint||"")}</div></div>`;
  } else if(config.type === "select"){
    inner += `<select id="${id}">${(config.options||[]).map(o=>`<option value="${escapeHtml(String(o.value??o))}">${escapeHtml(String(o.label??o))}</option>`).join("")}</select>`;
  } else if(config.type === "member" || config.type === "role" || config.type === "channel"){
    // searchable dropdown + input for id
    inner += `<div class="select-search"><input id="${id}_search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID..."/><div id="${id}_list" class="list-dropdown"></div></div>`;
    inner += `<div style="margin-top:8px"><input type="text" id="${id}_manual" placeholder="–í—Å—Ç–∞–≤–∏—Ç—å ID –≤—Ä—É—á–Ω—É—é..." /></div>`;
    inner += `<div style="margin-top:8px" class="small-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ ID.</div>`;
  } else if(config.type === "slider"){
    inner += `<div class="slider-row"><div style="width:56px" id="${id}_value_display">0</div><input type="range" id="${id}" min="${config.min||0}" max="${config.max||100}" step="${config.step||0.1}" /></div>`;
  } else if(config.type === "rewards"){
    inner += `<div style="margin-bottom:8px"><table class="rewards-table" id="${id}_table"><thead><tr><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–†–æ–ª—å (ID)</th><th></th></tr></thead><tbody></tbody></table></div>`;
    inner += `<div style="display:flex;gap:8px"><input id="${id}_lvl" type="number" min="1" max="1000" placeholder="–£—Ä–æ–≤–µ–Ω—å" /><input id="${id}_role" placeholder="Role ID" /><button id="${id}_add" class="button">–î–æ–±–∞–≤–∏—Ç—å</button></div>`;
    inner += `<div style="margin-top:8px"><button id="${id}_clear" class="button button-danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —É—Ä–æ–≤–Ω–∏</button></div>`;
  } else {
    inner += `<input type="text" id="${id}" />`;
  }

  // save row will be in drawer; but quick setter optionally
  wrapper.innerHTML = inner;

  // attach behaviors for toggles, slider, member/role/channel search, rewards
  if(config.type === "boolean"){
    const toggle = wrapper.querySelector(`#${id}_toggle`);
    toggle.addEventListener("click", ()=>{
      const on = toggle.classList.toggle("on");
      toggle.setAttribute("aria-checked", on ? "true" : "false");
    });
  }

  if(config.type === "slider"){
    const input = wrapper.querySelector(`#${id}`);
    const disp = wrapper.querySelector(`#${id}_value_display`);
    input.addEventListener("input", ()=>{ disp.textContent = input.value; });
    // initialize display
    setTimeout(()=>{ if(input) disp.textContent = input.value; }, 0);
  }

  if(config.type === "member" || config.type === "role" || config.type === "channel"){
    const search = wrapper.querySelector(`#${id}_search`);
    const list = wrapper.querySelector(`#${id}_list`);
    const manual = wrapper.querySelector(`#${id}_manual`);

    let lastQuery = "";
    let cached = []; // cache results for this session

    async function doSearch(q){
      q = (q||"").trim();
      if(q === lastQuery) return;
      lastQuery = q;
      list.innerHTML = `<div class="list-item small-muted">–ü–æ–∏—Å–∫...</div>`;
      try{
        const path = `/${config.type}s?guildId=${encodeURIComponent(guild.id)}&q=${encodeURIComponent(q)}`;
        const resp = await apiFetch(path);
        if(!resp.ok){ list.innerHTML = `<div class="list-item small-muted">–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è</div>`; return; }
        const arr = await resp.json();
        cached = Array.isArray(arr) ? arr : (arr && arr.items) ? arr.items : [];
        if(!cached.length){ list.innerHTML = `<div class="list-item small-muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`; return; }
        list.innerHTML = cached.map(it => `<div class="list-item" data-id="${escapeHtml(it.id)}" data-name="${escapeHtml(it.name||it.username||'')}">${escapeHtml(it.name || it.username || it.id)}</div>`).join("");
        list.querySelectorAll(".list-item").forEach(el=>{
          el.addEventListener("click", ()=>{
            const idv = el.dataset.id;
            manual.value = idv;
            list.innerHTML = `<div class="list-item small-muted">–í—ã–±—Ä–∞–Ω–æ: ${escapeHtml(el.dataset.name)}</div>`;
          });
        });
      }catch(e){
        console.warn("search error", e);
        list.innerHTML = `<div class="list-item small-muted">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>`;
      }
    }

    let debounce;
    search.addEventListener("input", (e)=>{
      clearTimeout(debounce);
      debounce = setTimeout(()=> doSearch(e.target.value), 250);
    });

    // initial load (no query) ‚Äî show popular/first items
    setTimeout(()=> doSearch(""), 200);
  }

  if(config.type === "rewards"){
    const table = wrapper.querySelector(`#${id}_table tbody`);
    const addBtn = wrapper.querySelector(`#${id}_add`);
    const lvlInp = wrapper.querySelector(`#${id}_lvl`);
    const roleInp = wrapper.querySelector(`#${id}_role`);
    const clearBtn = wrapper.querySelector(`#${id}_clear`);

    function renderRow(level, role){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(String(level))}</td><td>${escapeHtml(String(role))}</td><td class="rewards-actions"><button class="button" data-del>–£–¥–∞–ª–∏—Ç—å</button></td>`;
      tr.querySelector("[data-del]").addEventListener("click", ()=>{ tr.remove(); });
      return tr;
    }

    addBtn.addEventListener("click", ()=>{
      const lvl = parseInt(lvlInp.value,10);
      const role = roleInp.value.trim();
      if(!lvl || lvl < 1 || lvl > 1000){ alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å 1-1000"); return; }
      if(!role){ alert("–£–∫–∞–∂–∏—Ç–µ —Ä–æ–ª—å (ID)"); return; }
      // check duplicates
      const exists = Array.from(table.querySelectorAll("tr")).some(tr => parseInt(tr.cells[0].textContent,10) === lvl);
      if(exists){ alert("–ù–∞–≥—Ä–∞–¥–∞ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"); return; }
      table.appendChild(renderRow(lvl, role));
      lvlInp.value = ""; roleInp.value = "";
    });

    clearBtn.addEventListener("click", async ()=>{
      if(!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –Ω–∞–≥—Ä–∞–¥—ã –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä.")) return;
      // immediate request to clear
      try{
        const actions = [{ name: "clear_rewards", value: true }];
        const resp = await postActions(guild.id, actions);
        if(resp.ok){ table.innerHTML = ""; alert("–í—Å–µ –Ω–∞–≥—Ä–∞–¥—ã —É–¥–∞–ª–µ–Ω—ã"); }
        else { const t = await resp.text().catch(()=> ""); alert("–û—à–∏–±–∫–∞: " + resp.status + " " + t); }
      }catch(e){ alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message); }
    });
  }

  return wrapper;
}

/* ========== Schema builder: build sections with createField ========== */
function buildGeneralSection(guild){
  const container = document.createElement("div");
  container.className = "card-surface";
  container.innerHTML = `<h3>–û—Å–Ω–æ–≤–Ω—ã–µ</h3><p class="small muted">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ä–≤–µ—Ä–∞</p>`;
  // prefix
  container.appendChild(createField({ id:"prefix", label:"–ü—Ä–µ—Ñ–∏–∫—Å –±–æ—Ç–∞", type:"text", placeholder:"!" }, guild));
  // welcome channel
  container.appendChild(createField({ id:"welcome_channel", label:"–ö–∞–Ω–∞–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π", type:"channel", description:"–ö–∞–Ω–∞–ª –≥–¥–µ –±—É–¥—É—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è" }, guild));
  // starter roles (multiple roles) -> use role type but allow comma-separated values in manual
  container.appendChild(createField({ id:"starter_roles", label:"–ù–∞—á–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏ (IDs)", type:"role", description:"–î–æ–±–∞–≤—å—Ç–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–¥–∞—é—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ" }, guild));
  return container;
}

function buildCounterSection(guild){
  const container = document.createElement("div");
  container.className = "card-surface";
  container.innerHTML = `<h3>–°—á—ë—Ç—á–∏–∫</h3><p class="small muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—á—ë—Ç—á–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</p>`;
  // counter channel (single)
  container.appendChild(createField({ id:"counter_channel", label:"–ö–∞–Ω–∞–ª —Å—á—ë—Ç—á–∏–∫–∞", type:"channel", description:"–ú–∞–∫—Å–∏–º—É–º 1 –∫–∞–Ω–∞–ª. –£–¥–∞–ª–∏—Ç–µ —á—Ç–æ–±—ã —Å–Ω—è—Ç—å." }, guild));
  // counter value (number) with separate setter
  const counterField = createField({ id:"counter_value", label:"–ó–Ω–∞—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞", type:"number", min:0, max:999999, separateSetter:true }, guild);
  // add separate "Set" button
  const setRow = document.createElement("div");
  setRow.style.marginTop = "8px";
  setRow.innerHTML = `<button id="set_counter_btn" class="button">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ</button> <span class="small-muted" id="set_counter_status"></span>`;
  counterField.appendChild(setRow);
  container.appendChild(counterField);

  // allow math, allow /calculate booleans
  container.appendChild(createField({ id:"allow_math", label:"–†–∞–∑—Ä–µ—à–∏—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏–∫—É", type:"boolean", hint:"–†–∞–∑—Ä–µ—à–∏—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è" }, guild));
  container.appendChild(createField({ id:"allow_calculate_cmd", label:"–†–∞–∑—Ä–µ—à–∏—Ç—å /calculate", type:"boolean" }, guild));
  // tolerance (float slider)
  container.appendChild(createField({ id:"counter_tolerance", label:"–¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å —Å—á—ë—Ç—á–∏–∫–∞", type:"slider", min:0.01, max:1, step:0.01 }, guild));

  // attach setter behavior
  setRow.querySelector("#set_counter_btn").addEventListener("click", async ()=>{
    const valInput = counterField.querySelector("#counter_value");
    const value = valInput ? Number(valInput.value) : NaN;
    if(!Number.isInteger(value)){ alert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ"); return; }
    const status = document.getElementById("set_counter_status");
    status.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    try{
      const resp = await postActions(guild.id, [{ name:"set_counter", value }]);
      if(resp.ok){ status.textContent = "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"; setTimeout(()=> status.textContent = "", 1500); }
      else { const t = await resp.text().catch(()=> ""); status.textContent = "–û—à–∏–±–∫–∞: "+resp.status; console.warn("set counter error", t); }
    }catch(e){ status.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; }
  });

  return container;
}

function buildLevelsSection(guild){
  const container = document.createElement("div");
  container.className = "card-surface";
  container.innerHTML = `<h3>–£—Ä–æ–≤–Ω–∏</h3><p class="small muted">–°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π –∏ –Ω–∞–≥—Ä–∞–¥</p>`;
  container.appendChild(createField({ id:"levels_channel", label:"–ö–∞–Ω–∞–ª —É—Ä–æ–≤–Ω–µ–π", type:"channel", description:"–ú–∞–∫—Å–∏–º—É–º 1 –∫–∞–Ω–∞–ª" }, guild));
  container.appendChild(createField({ id:"rewards", label:"–ù–∞–≥—Ä–∞–¥—ã –∑–∞ —É—Ä–æ–≤–Ω–∏", type:"rewards" }, guild));
  container.appendChild(createField({ id:"reactions_for_xp", label:"–í—ã–¥–∞–≤–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å –∑–∞ —Ä–µ–∞–∫—Ü–∏–∏", type:"boolean" }, guild));
  container.appendChild(createField({ id:"voice_time_xp", label:"–í—ã–¥–∞–≤–∞—Ç—å —É—Ä–æ–≤–Ω–∏ –∑–∞ –≥–æ–ª–æ—Å–æ–≤–æ–µ –≤—Ä–µ–º—è", type:"boolean" }, guild));
  container.appendChild(createField({ id:"level_modifier", label:"–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è", type:"slider", min:0.1, max:10, step:0.1 }, guild));
  return container;
}

/* ========== Drawer (save UI) ========= */
const drawerState = {
  open: false,
  dirty: false,
  currentGuild: null,
  pendingActions: []
};

function openDrawer(guild, pendingActions){
  drawerState.open = true;
  drawerState.dirty = true;
  drawerState.currentGuild = guild;
  drawerState.pendingActions = pendingActions || [];
  const backdrop = document.getElementById("drawer_backdrop");
  const drawer = document.getElementById("drawer_panel");
  document.getElementById("drawer_actions_list").innerHTML = pendingActions.map(a => `<div style="display:flex;justify-content:space-between;padding:6px 0"><div><b>${escapeHtml(a.name)}</b>: ${escapeHtml(String(a.value))}</div></div>`).join("");
  backdrop.style.display = "flex";
  drawer.classList.add("show");
  // intercept navigation via hashchange by setting global flag (handled elsewhere)
}

function closeDrawer(success){
  drawerState.open = false;
  drawerState.dirty = false;
  drawerState.pendingActions = [];
  drawerState.currentGuild = null;
  const backdrop = document.getElementById("drawer_backdrop");
  const drawer = document.getElementById("drawer_panel");
  drawer.classList.remove("show");
  backdrop.style.display = "none";
}

/* ========== Page rendering ========== */
function renderLogin(user){
  return `
    ${topBar(user)}
    <main class="layout">
      <section class="card" style="max-width:720px;margin:80px auto;text-align:center">
        <h1 class="title">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord</h1>
        <p class="muted">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –≥–∏–ª—å–¥–∏—è–º–∏ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å PollPi.</p>
        <div style="margin-top:18px"><a href="${API_BASE}/login"><button class="button button-primary">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord</button></a></div>
      </section>
    </main>
  `;
}

function renderGuilds(user, guilds, searchVal=""){
  // sort: botPresent first
  guilds = guilds.slice().sort((a,b) => (b.botPresent?1:0) - (a.botPresent?1:0));
  return `
    ${topBar(user)}
    <main class="layout">
      <div class="controls-row">
        <div class="search">
          <input id="guildSearch" placeholder="–ü–æ–∏—Å–∫ –≥–∏–ª—å–¥–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ ID..." value="${escapeHtml(searchVal||"")}" />
          <button id="refreshBtn" class="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="small-muted">${guilds.length} —Å–µ—Ä–≤–µ—Ä(–æ–≤)</div>
      </div>
      <h1 class="title">–ì–∏–ª—å–¥–∏–∏</h1>
      <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –°–Ω–∞—á–∞–ª–∞ ‚Äî –≥–¥–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –±–æ—Ç.</p>
      <section class="grid guild-grid">
        ${guilds.length ? guilds.map(g => guildCard(g)).join("") : `<div class="card empty">–°–ø–∏—Å–æ–∫ –≥–∏–ª—å–¥–∏–π –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</div>`}
      </section>
    </main>
    <!-- drawer DOM -->
    <div id="drawer_backdrop" class="drawer-backdrop"><div id="drawer_panel" class="drawer card-surface">
      <div class="drawer-header"><strong>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</strong><div style="margin-left:auto" id="drawer_status_text"></div></div>
      <div class="drawer-body" id="drawer_actions_list"></div>
      <div class="drawer-footer">
        <button id="drawer_cancel" class="button">–û—Ç–º–µ–Ω–∞</button>
        <button id="drawer_save" class="button button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å <span id="drawer_save_spinner" style="display:none;margin-left:8px" class="spinner"></span></button>
      </div>
    </div></div>
  `;
}

function renderPanelHeader(guild){
  return `<div style="display:flex;gap:12px;align-items:center;margin-bottom:12px"><button id="backToGuilds" class="button">‚Üê –ù–∞–∑–∞–¥</button><h2 class="title" style="margin:0">${escapeHtml(guild.name||guild.id)}</h2><div style="margin-left:auto" class="small-muted">ID: ${escapeHtml(String(guild.id))}</div></div>`;
}

/* ========== App state & helpers ========== */
let cachedGuilds = [];
let cachedUser = null;
let currentGuild = null;
let currentTab = "general";

/* load guilds and init */
async function loadGuilds(){
  try{
    const r = await apiFetch("/guilds");
    if(!r.ok){
      let hint = "";
      try{ const j = await r.json(); hint = JSON.stringify(j); }catch(e){}
      throw { status: r.status, hint };
    }
    const data = await r.json();
    return data.guilds || [];
  }catch(e){
    throw e;
  }
}

async function initAuth(){
  const r = await apiFetch("/me");
  if(!r.ok) return { logged:false };
  return r.json();
}

/* ==== glue for panel: render settings tabs and fields ==== */
function renderSettingsUIForGuild(guild){
  const main = document.getElementById("panelMain");
  if(!main) return;

  main.innerHTML = `
    <div class="card-surface">
      <div id="panelHeader"></div>
      <div id="panelTabs" style="display:flex;gap:8px;margin-bottom:12px"></div>
      <div id="panelContent"></div>
    </div>
  `;

  document.getElementById("panelHeader").innerHTML = renderPanelHeader(guild);
  document.getElementById("backToGuilds")?.addEventListener("click", ()=>{
    location.hash = "#/guilds";
    renderApp();
  });

  const tabs = [
    { key: "general", title: "–û—Å–Ω–æ–≤–Ω—ã–µ", builder: buildGeneralSection },
    { key: "counter", title: "–°—á—ë—Ç—á–∏–∫", builder: buildCounterSection },
    { key: "levels", title: "–£—Ä–æ–≤–Ω–∏", builder: buildLevelsSection },
  ];

  const tabsNode = document.getElementById("panelTabs");
  tabsNode.innerHTML = tabs.map(t =>
    `<button class="tab ${t.key===currentTab ? "active":""}" data-tab="${t.key}">${escapeHtml(t.title)}</button>`
  ).join("");

  tabsNode.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(drawerState.dirty){
        alert("–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π —Ä–∞–∑–¥–µ–ª–∞.");
        return;
      }
      currentTab = btn.dataset.tab;
      renderSettingsUIForGuild(guild);
    });
  });

  const content = document.getElementById("panelContent");
  content.innerHTML = "";

  const section = tabs.find(t=>t.key===currentTab) || tabs[0];
  content.appendChild(section.builder(guild));

  const saveWrap = document.createElement("div");
  saveWrap.style.marginTop = "12px";
  saveWrap.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small-muted">–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –≤ –æ–∫–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
      <div>
        <button id="open_save_drawer" class="button button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ</button>
      </div>
    </div>
  `;
  content.appendChild(saveWrap);

  document.getElementById("open_save_drawer")?.addEventListener("click", ()=>{
    const actions = gatherActionsFromUI(guild);
    if(!actions.length){
      alert("–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
      return;
    }
    openDrawer(guild, actions);
  });

  /* --- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ drawer --- */
  if(!document.getElementById("drawer_backdrop")){
    document.body.insertAdjacentHTML("beforeend", `
      <div id="drawer_backdrop" class="drawer-backdrop" style="display:none">
        <div id="drawer_panel" class="drawer card-surface">
          <div class="drawer-header">
            <strong>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</strong>
            <div style="margin-left:auto" id="drawer_status_text"></div>
          </div>
          <div class="drawer-body" id="drawer_actions_list"></div>
          <div class="drawer-footer">
            <button id="drawer_cancel" class="button">–û—Ç–º–µ–Ω–∞</button>
            <button id="drawer_save" class="button button-primary">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              <span id="drawer_save_spinner" style="display:none;margin-left:8px" class="spinner"></span>
            </button>
          </div>
        </div>
      </div>
    `);
  }

  /* --- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ --- */
  const cancelBtn = document.getElementById("drawer_cancel");
  const saveBtn = document.getElementById("drawer_save");

  if(cancelBtn){
    cancelBtn.onclick = ()=> closeDrawer(false);
  }

  if(saveBtn){
    saveBtn.onclick = async ()=>{
      const spinner = document.getElementById("drawer_save_spinner");
      saveBtn.disabled = true;
      if(spinner) spinner.style.display = "inline-block";

      try{
        const resp = await postActions(drawerState.currentGuild.id, drawerState.pendingActions);
        if(resp.ok){
          closeDrawer(true);
          alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ");
        } else {
          const text = await resp.text().catch(()=> "");
          alert("–û—à–∏–±–∫–∞: " + resp.status + " " + text);
        }
      }catch(e){
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message);
      }

      if(spinner) spinner.style.display = "none";
      saveBtn.disabled = false;
    };
  }

  window.onbeforeunload = (ev)=>{
    if(drawerState.dirty){
      const msg = "–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.";
      ev.returnValue = msg;
      return msg;
    }
  };
}

/* gather actions from UI: we look for fields inside panelContent and build actions array */
function gatherActionsFromUI(guild){
  const actions = [];
  const panelContent = document.getElementById("panelContent");
  if(!panelContent) return actions;

  // helper to detect value per field id
  function readField(id){
    const el = panelContent.querySelector(`#${id}`);
    if(el && el.type === "checkbox") return el.checked;
    if(el && el.tagName === "SELECT") return Array.from(el.options).map(o=>o.value || o.textContent);
    if(el && el.tagName === "INPUT" && (el.type === "text" || el.type === "number")) return el.value;
    // toggles
    const togg = panelContent.querySelector(`#${id}_toggle`);
    if(togg) return togg.classList.contains("on");
    // manual selects
    const manual = panelContent.querySelector(`#${id}_manual`);
    if(manual) return manual.value;
    // slider
    const slider = panelContent.querySelector(`#${id}`);
    if(slider && slider.type === "range") return slider.value;
    // rewards table
    const table = panelContent.querySelector(`#${id}_table`);
    if(table){
      const out = [];
      table.querySelectorAll("tbody tr").forEach(tr=>{
        const lvl = parseInt(tr.cells[0].textContent, 10);
        const role = tr.cells[1].textContent.trim();
        out.push({ level: lvl, role: role });
      });
      return out;
    }
    // fallback
    if(el) return el.value;
    return null;
  }

  // explicit list of known ids we created in build* functions
  const ids = [
    "prefix", "welcome_channel", "starter_roles",
    "counter_channel", "counter_value", "allow_math", "allow_calculate_cmd", "counter_tolerance",
    "levels_channel", "rewards", "reactions_for_xp", "voice_time_xp", "level_modifier"
  ];

  ids.forEach(id=>{
    const val = readField(id);
    if(val !== null && val !== "" && !(Array.isArray(val) && val.length===0)){
      actions.push({ name: id, value: val });
    }
  });

  return actions;
}

/* ========== App rendering ========== */
async function renderApp(forceReload = false){
  setTheme(getTheme());
  const root = document.getElementById("root");
  try{
    const auth = await initAuth();
    if(!auth.logged){
      root.innerHTML = renderLogin(null);
      document.getElementById("loginBtn")?.addEventListener("click", ()=> location.href = API_BASE + "/login");
      return;
    }
    cachedUser = auth.user;
    // handle routes
    const hash = (location.hash || "#/guilds").replace("#", "");
    const [_, route, guildId] = hash.split("/");

    if(route === "guild" && guildId){
      // load guilds first (for permission check)
      if(!cachedGuilds.length || forceReload){
        cachedGuilds = await loadGuilds();
      }
      const guild = cachedGuilds.find(g=>String(g.id) === String(guildId));
      if(!guild){
        alert("–ì–∏–ª—å–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —Ç–æ–∫–µ–Ω—ã –∏—Å—Ç–µ–∫–ª–∏. –ü–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å.");
        location.hash = "#/guilds";
        return renderApp();
      }
      // show only if admin OR bot present (we allow both but check permission)
      if(!guild.isAdmin){
        alert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–π –≥–∏–ª—å–¥–∏–∏.");
        location.hash = "#/guilds";
        return renderApp();
      }

      currentGuild = guild;
      root.innerHTML = `${topBar(auth.user)}<main class="layout"><div id="panelWrapper"></div></main>`;
      // panel wrapper
      const panelWrapper = document.getElementById("panelWrapper");
      panelWrapper.innerHTML = `<div class="panel"><aside class="side"><div style="font-weight:800;margin-bottom:8px">–†–∞–∑–¥–µ–ª—ã</div><div id="tabs_list"></div></aside><section id="panelMain" class="card-surface"></section></div>`;
      // fill tabs list
      const tabsHtml = ["general","counter","levels"].map(t=>`<button class="tab ${t===currentTab? "active":""}" data-tab="${t}">${t==="general"?"–û—Å–Ω–æ–≤–Ω—ã–µ": t==="counter"?"–°—á—ë—Ç—á–∏–∫":"–£—Ä–æ–≤–Ω–∏"}</button>`).join("");
      document.getElementById("tabs_list").innerHTML = tabsHtml;

      // attach events to tabs (they will use drawerState.dirty to block switching)
      document.querySelectorAll("#tabs_list .tab").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(drawerState.dirty){
            alert("–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π —Ä–∞–∑–¥–µ–ª–∞.");
            return;
          }
          currentTab = btn.dataset.tab;
          renderSettingsUIForGuild(guild);
          // rerender tabs active state
          document.querySelectorAll("#tabs_list .tab").forEach(x=>x.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      renderSettingsUIForGuild(guild);
      // attach global events
      document.getElementById("logoutBtn")?.addEventListener("click", async ()=>{
        localStorage.removeItem(TOKEN_KEY);
        try{ await fetch(API_BASE + "/logout", { credentials: "include" }); }catch(e){}
        location.hash = "#/guilds";
        renderApp();
      });
      document.getElementById("themeBtn")?.addEventListener("click", ()=>{ const next = getTheme()==="dark"?"light":"dark"; setTheme(next); renderApp(); });
      return;
    }

    // default: guilds list
    // refresh cache if empty or forced
    if(!cachedGuilds.length || forceReload){
      cachedGuilds = await loadGuilds();
    }
    root.innerHTML = renderGuilds(auth.user, cachedGuilds, sessionStorage.getItem("guild_search") || "");
    // attach events
    document.getElementById("refreshBtn")?.addEventListener("click", ()=> renderApp(true));
    document.getElementById("guildSearch")?.addEventListener("input", (e)=>{ sessionStorage.setItem("guild_search", e.target.value); filterGuildsOnPage(e.target.value); });
    document.querySelectorAll("[data-copy-id]").forEach(btn => btn.addEventListener("click", async ()=>{ try{ await navigator.clipboard.writeText(btn.dataset.copyId); const prev = btn.textContent; btn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"; setTimeout(()=>btn.textContent = prev, 1200); }catch(e){ console.warn(e); } }));
    document.querySelectorAll("[data-open-guild]").forEach(btn => btn.addEventListener("click", ()=>{
      const id = btn.dataset.openGuild;
      // find guild and navigate
      location.hash = "#/guild/" + id;
      renderApp();
    }));

    // drawer DOM exists in this page too (so we must create only once)
    if(!document.getElementById("drawer_backdrop")){
      document.body.insertAdjacentHTML("beforeend", `
        <div id="drawer_backdrop" class="drawer-backdrop" style="display:none">
          <div id="drawer_panel" class="drawer card-surface">
            <div class="drawer-header"><strong>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</strong><div style="margin-left:auto" id="drawer_status_text"></div></div>
            <div class="drawer-body" id="drawer_actions_list"></div>
            <div class="drawer-footer">
              <button id="drawer_cancel" class="button">–û—Ç–º–µ–Ω–∞</button>
              <button id="drawer_save" class="button button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å <span id="drawer_save_spinner" style="display:none;margin-left:8px" class="spinner"></span></button>
            </div>
          </div>
        </div>
      `);
    }

    // attach global topbar events
    document.getElementById("logoutBtn")?.addEventListener("click", async ()=>{
      localStorage.removeItem(TOKEN_KEY);
      try{ await fetch(API_BASE + "/logout", { credentials: "include" }); }catch(e){}
      location.hash = "#/guilds";
      renderApp();
    });
    document.getElementById("themeBtn")?.addEventListener("click", ()=>{ const next = getTheme()==="dark"?"light":"dark"; setTheme(next); renderApp(); });
  }catch(e){
    root.innerHTML = `<main class="layout"><section class="card"><h2>–û—à–∏–±–∫–∞</h2><pre>${escapeHtml(e && e.message ? e.message : String(e))}</pre></section></main>`;
  }
}

/* filter function on guild grid */
function filterGuildsOnPage(q){
  q = (q||"").toLowerCase().trim();
  document.querySelectorAll(".guild-card").forEach(card=>{
    const title = (card.querySelector("h3")?.textContent || "").toLowerCase();
    const meta = (card.querySelector(".guild-meta")?.textContent || "").toLowerCase();
    const gid = (card.dataset.guildId || "").toLowerCase();
    if(!q || title.includes(q) || meta.includes(q) || gid.includes(q)) card.style.display = "";
    else card.style.display = "none";
  });
}

/* ========== Init ========== */
window.addEventListener("hashchange", () => {
  // block navigation if drawer open/dirty
  if(drawerState.dirty){
    alert("–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º.");
    // revert hash change by re-setting location
    setTimeout(()=> { location.hash = location.hash; }, 0);
    return;
  }
  renderApp();
});
window.addEventListener("storage", ()=> setTheme(getTheme()));
renderApp();

</script>
</body>
</html>
