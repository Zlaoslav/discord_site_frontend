<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>PollPi Dashboard</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --bg:#0b1020; --surface:#141b2f; --surface-soft:#1a2440; --text:#eaf0ff; --muted:#9ca9cb; --primary:#6f7bff; --border:#2a355a; --ok:#2ecc71; --danger:#ff7b7b; --shadow:0 10px 30px rgba(0,0,0,.35); }
    :root[data-theme="light"] { --bg:#f4f7ff; --surface:#ffffff; --surface-soft:#f2f5ff; --text:#0d1733; --muted:#4f5f86; --primary:#5865f2; --border:#dbe3ff; --ok:#14995e; --danger:#d93636; --shadow:0 8px 26px rgba(51,78,148,.12); }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1000px 600px at 80% -20%, rgba(88,101,242,.08), transparent),var(--bg);color:var(--text);min-height:100vh}

    .topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:12px;padding:12px 18px;backdrop-filter:blur(6px);background:color-mix(in srgb,var(--bg) 82%,transparent);border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:6px;margin-right:auto;font-size:16px}
    .brand img{width:32px;height:32px;border-radius:8px}
    .brand .title{font-weight:800;letter-spacing:.6px}
    .nav-center{margin:auto;text-align:center}
    .user-area{display:flex;align-items:center;gap:10px;margin-left:auto}
    .user-name{font-weight:700;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .avatar{width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:var(--surface-soft);object-fit:cover}

    .button{border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600;color:var(--text);background:var(--surface);transition:.12s}
    .button:hover{transform:translateY(-1px)}
    .button-primary{background:var(--primary);border-color:transparent;color:#fff}
    .button-danger{background:color-mix(in srgb,var(--danger) 12%,var(--surface));border-color:color-mix(in srgb,var(--danger) 40%,var(--border))}
    .button-invite{background:var(--ok);border-color:transparent;color:#04210a}
    .button-disabled{opacity:.5;cursor:not-allowed}

    .layout{max-width:1100px;margin:26px auto;padding:0 14px 40px}
    .title{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted);margin:0}

    .grid{display:grid;gap:14px;margin-top:18px}
    .guild-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{border:1px solid var(--border);border-radius:14px;background:var(--surface);box-shadow:var(--shadow);padding:14px}
    .guild-card{display:flex;flex-direction:column;gap:8px}
    .guild-card .g-head{display:flex;gap:12px;align-items:center}
    .guild-card h3{margin:0;font-size:18px}
    .guild-meta{color:var(--muted);font-size:13px;margin:0}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;padding:6px 8px;border-radius:999px;background:var(--surface-soft);border:1px solid var(--border);color:var(--muted)}

    .controls-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .search{flex:1;display:flex;gap:8px;align-items:center}
    .search input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text)}
    .small-muted{color:var(--muted);font-size:13px}

    .center-card{max-width:720px;margin:80px auto;text-align:center}
    .login-hero{border-radius:16px;padding:32px;background:linear-gradient(180deg,color-mix(in srgb,var(--surface) 86%,transparent),var(--surface));border:1px solid var(--border);box-shadow:var(--shadow)}
    .login-hero h1{margin:0 0 10px}
    .login-hero p.lead{margin:0 0 20px;color:var(--muted)}

    .panel{display:grid;grid-template-columns:260px 1fr;gap:14px;margin-top:18px}
    .side{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--surface-soft)}
    .tab{display:block;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid var(--border);background:transparent;color:var(--text);text-align:left}
    .tab.active{background:var(--primary);color:#fff;border-color:transparent}
    .setting{border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px;background:var(--surface)}
    label{font-weight:700;display:block;margin-bottom:6px}
    input[type=text], input[type=number], select, textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text)}
    .row{display:flex;gap:8px}
    .switch{display:flex;align-items:center;gap:8px}
    .switch input{transform:scale(1.1)}
    .small{font-size:13px;color:var(--muted)}

    @media(max-width:840px){.guild-grid{grid-template-columns:1fr}.brand .title{display:none}.nav-center{display:none}.user-name{display:none}.panel{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div id="root"></div>

<script>
/* CONFIG */
const API_BASE="https://pollpi.slavi.workers.dev";
const TOKEN_KEY="pollpi_token";
const THEME_KEY="ui_theme";
const DISCORD_INVITE_BASE="https://discord.com/oauth2/authorize?client_id=1409084528588488727&scope=bot%20applications.commands&permissions=8";

/* SETTINGS */
const SETTINGS_TABS=[
  {key:'general',title:'–û–±—â–∏–µ'},
  {key:'moderation',title:'–ú–æ–¥–µ—Ä–∞—Ü–∏—è'},
  {key:'fun',title:'–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è'},
  {key:'autos',title:'–ê–≤—Ç–æ–∑–∞–¥–∞—á–∏'},
  {key:'notifications',title:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'}
];
const SETTINGS_SCHEMA={
  general:[
    {id:'prefix',label:'–ü—Ä–µ—Ñ–∏–∫—Å –∫–æ–º–∞–Ω–¥',type:'text',placeholder:'!',hint:'–¢–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∫–æ–º–∞–Ω–¥'},
    {id:'welcome_channel',label:'–ö–∞–Ω–∞–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π (ID)',type:'text',placeholder:'123456789012345678'},
    {id:'max_active_polls',label:'–ú–∞–∫—Å. –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤',type:'number',min:0,max:100}
  ],
  moderation:[
    {id:'mod_log_channel',label:'–ö–∞–Ω–∞–ª –ª–æ–≥–æ–≤ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ (ID)',type:'text'},
    {id:'auto_mute',label:'–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º—É—Ç–∏—Ç—å –ø—Ä–∏ X –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π',type:'number',min:0,max:50},
    {id:'mod_enabled',label:'–í–∫–ª—é—á–∏—Ç—å –º–æ–¥–µ—Ä–∞—Ü–∏—é',type:'boolean'}
  ],
  fun:[
    {id:'memes_channel',label:'–ö–∞–Ω–∞–ª –º–µ–º–æ–≤ (ID)',type:'text'},
    {id:'fun_role',label:'–†–æ–ª—å –¥–ª—è –∏–≥—Ä',type:'role'},
    {id:'joke_probability',label:'–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —à—É—Ç–∫–∏ (%)',type:'number',min:0,max:100}
  ],
  autos:[
    {id:'daily_message',label:'–¢–µ–∫—Å—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è',type:'text'},
    {id:'daily_enabled',label:'–í–∫–ª—é—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è',type:'boolean'},
    {id:'dropdown_sample',label:'–ü—Ä–∏–º–µ—Ä –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞',type:'select',options:['–í–∞—Ä–∏–∞–Ω—Ç A','–í–∞—Ä–∏–∞–Ω—Ç B']}
  ],
  notifications:[
    {id:'notify_role',label:'–†–æ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π',type:'role'},
    {id:'notify_on_join',label:'–£–≤–µ–¥–æ–º–ª—è—Ç—å –ø—Ä–∏ –≤—Ö–æ–¥–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞',type:'boolean'},
    {id:'webhook_url',label:'Webhook URL',type:'text'}
  ]
};

/* HELPERS */
(function grabTokenFromHash(){try{if(location.hash.includes('token=')){const params=new URLSearchParams(location.hash.slice(1));const t=params.get('token');if(t){localStorage.setItem(TOKEN_KEY,t);history.replaceState(null,'', location.pathname+location.search)}}}catch(e){console.warn(e)}})();
function getToken(){return localStorage.getItem(TOKEN_KEY)}
function getTheme(){return localStorage.getItem(THEME_KEY)||'dark'}
function setTheme(theme){document.documentElement.dataset.theme=theme;localStorage.setItem(THEME_KEY,theme)}
function escapeHtml(raw){return String(raw||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;")}
function buildAvatarUrl(user){if(!user)return'https://cdn.discordapp.com/embed/avatars/0.png';if(user.avatar)return`https://cdn.discordapp.com/avatars/${user.id||user.sub}/${user.avatar}.png`;let idx=0;try{idx=(parseInt(user.discriminator||'0',10)||0)%5}catch(e){idx=0}return`https://cdn.discordapp.com/embed/avatars/${idx}.png`}

/* API */
async function apiFetch(path,opts={}){opts=opts||{};opts.headers=opts.headers||{};const token=getToken();if(token)opts.headers['Authorization']='Bearer '+token;opts.credentials='include';const url=path.startsWith('/')?(API_BASE+path):(API_BASE+'/'+path);return fetch(url,opts)}
async function loadGuilds(){const resp=await apiFetch('/guilds');if(!resp.ok){let hint='';try{hint=await resp.json()}catch(e){}throw{status:resp.status,hint}}const data=await resp.json();return Array.isArray(data.guilds)?data.guilds:(Array.isArray(data)?data:[])}
async function initAuth(){const resp=await apiFetch('/me');if(!resp.ok)return{logged:false};return resp.json()}
async function sendSetting(guildId,tabKey,settingId,value){const payload={guildId,tab:tabKey,settingId,value};try{const r=await apiFetch('/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});return r}catch(e){throw e}}

/* TOPBAR */
function topBar(user){
  const avatarUrl=user?buildAvatarUrl(user):'';
  const username=user?escapeHtml(user.username||user.name||'User'):'';
  const loggedIn=!!user;
  const themeIcon=getTheme()==='dark'?'üåô':'‚òÄÔ∏è';
  return `<header class="topbar">
    <div class="brand">
      <img src="favicon.png" alt="icon">
      <div class="title">PollPi</div>
      <span style="background:#5865f2;color:white;padding:2px 6px;border-radius:4px;font-size:12px;font-weight:700;margin-left:4px;">–ë–û–¢</span>
      <small class="muted" style="margin-left:6px;">Dashboard</small>
    </div>
    <div class="nav-center" aria-hidden="true"></div>
    <div class="user-area">
      ${loggedIn?`<img class="avatar" src="${avatarUrl}" alt="avatar"><div class="user-name">${username}</div><button id="logoutBtn" class="button button-danger">–í—ã–π—Ç–∏</button>`:`<button id="loginBtn" class="button" style="border:1px solid var(--primary);background:transparent;color:var(--primary);">–í–æ–π—Ç–∏</button>`}
      <button id="themeBtn" class="button">${themeIcon}</button>
    </div>
  </header>`;
}

/* attach login button */
document.addEventListener('click', e=>{
  if(e.target?.id==='loginBtn'){
    window.location.href = API_BASE + '/login';
  }
});

/* PAGES */
function renderLoginPage(){ return `${topBar(null)}<main class="layout"><section class="center-card"><div class="login-hero card"><h1>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord</h1><p class="lead">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å PollPi. –í—Ö–æ–¥ –±–µ–∑–æ–ø–∞—Å–µ–Ω ‚Äî –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ Discord.</p><div style="display:flex;gap:12px;justify-content:center;margin-top:12px"><a href="${API_BASE}/login"><button class="button button-primary">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord</button></a></div><div style="margin-top:18px;color:var(--muted);font-size:13px">–í–∞–∂–Ω–æ: –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –≥–∏–ª—å–¥–∏–π, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø.</div></div></section></main>`; }

function renderGuildsPage(user, guilds, searchVal = ''){
  const empty = '<div class="card empty">–°–ø–∏—Å–æ–∫ –≥–∏–ª—å–¥–∏–π –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</div>';
  return `${topBar(user)}<main class="layout"><div class="controls-row"><div class="search"><input id="guildSearch" type="text" placeholder="–ü–æ–∏—Å–∫ –≥–∏–ª—å–¥–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ ID..." value="${escapeHtml(searchVal||'')}" /><button id="refreshBtn" class="button">–û–±–Ω–æ–≤–∏—Ç—å</button></div><div class="small-muted">${guilds && guilds.length ? guilds.length + ' —Å–µ—Ä–≤–µ—Ä(–æ–≤)' : ''}</div></div><h1 class="title">–ì–∏–ª—å–¥–∏–∏</h1><p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PollPi.</p><section class="grid guild-grid">${guilds && guilds.length ? guilds.map(guildCard).join('') : empty}</section></main>`;
}

function renderGuildPanelPage(user, guild){
  const tabsHtml = SETTINGS_TABS.map(t=>`<button class="tab" data-tab="${t.key}">${escapeHtml(t.title)}</button>`).join('');
  return `${topBar(user)}<main class="layout"><div style="display:flex;gap:12px;align-items:center;margin-bottom:12px"><button id="backToGuilds" class="button">‚Üê –ù–∞–∑–∞–¥ –∫ –≥–∏–ª—å–¥–∏—è–º</button><h2 class="title">–ü–∞–Ω–µ–ª—å —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî ${escapeHtml(guild.name || guild.id)}</h2><div style="margin-left:auto;color:var(--muted)">Guild ID: ${escapeHtml(guild.id)}</div></div><div class="panel"><aside class="side"><div style="font-weight:800;margin-bottom:8px">–†–∞–∑–¥–µ–ª—ã</div>${tabsHtml}</aside><section class="card" id="panelMain"><h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞</h3><p class="small muted">–¢–µ—Å—Ç–æ–≤—ã–µ –≤–∫–ª–∞–¥–∫–∏ —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –≤–≤–æ–¥–∞. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ /action (backend –æ–±—è–∑–∞–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å).</p><div id="tabContent"></div></section></div></main>`;
}

/* EVENTS */
function attachGlobalEvents(){ document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{ localStorage.removeItem(TOKEN_KEY); try{ await fetch(API_BASE + '/logout', { credentials: 'include' }); }catch(e){} location.hash = '#/guilds'; location.reload(); }); document.getElementById('themeBtn')?.addEventListener('click', ()=>{ const current=getTheme(); setTheme(current==='dark'?'light':'dark'); document.documentElement.dataset.theme=getTheme(); }); }

function attachGuildsPageEvents(){ document.querySelectorAll('[data-copy-id]').forEach(btn=>btn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(btn.dataset.copyId); const prev = btn.textContent; btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'; setTimeout(()=>btn.textContent = prev,1200); }catch(e){ console.warn(e); } }));
  document.querySelectorAll('[data-open-guild]').forEach(btn=>btn.addEventListener('click', ()=>{ location.hash = '#/guild/' + btn.dataset.openGuild; }));
  const refresh = document.getElementById('refreshBtn'); if(refresh) refresh.addEventListener('click', ()=>renderApp(true));
  const search = document.getElementById('guildSearch'); if(search){ search.addEventListener('input', (e)=>{ sessionStorage.setItem('guild_search', e.target.value); filterGuildsOnPage(e.target.value); }); search.focus(); }
}

function attachPanelEvents(guild){
  document.getElementById('backToGuilds')?.addEventListener('click', ()=>{ location.hash = '#/guilds'; renderApp(); });
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',(e)=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); renderSettingsTab(guild, t.dataset.tab);
  }));
  // activate first tab
  const firstTab = document.querySelector('.tab'); if(firstTab){ firstTab.classList.add('active'); renderSettingsTab(guild, firstTab.dataset.tab); }
}

/* render settings tab */
function renderSettingsTab(guild, tabKey){
  const container = document.getElementById('tabContent'); if(!container) return; container.innerHTML = '';
  const schema = SETTINGS_SCHEMA[tabKey] || [];
  schema.forEach(control => {
    const el = document.createElement('div'); el.className = 'setting';
    const id = control.id;
    let inner = `<label for="${id}">${escapeHtml(control.label || id)}</label>`;
    if(control.type === 'text'){
      inner += `<input type="text" id="${id}" placeholder="${escapeHtml(control.placeholder || '')}" />`;
    } else if(control.type === 'number'){
      inner += `<input type="number" id="${id}" min="${control.min||''}" max="${control.max||''}" />`;
    } else if(control.type === 'boolean'){
      inner += `<div class="switch"><input type="checkbox" id="${id}" /><span class="small">–î–∞ / –ù–µ—Ç</span></div>`;
    } else if(control.type === 'select'){
      inner += `<select id="${id}">` + (Array.isArray(control.options)? control.options.map(o=>`<option>${escapeHtml(o)}</option>`).join('') : '') + `</select>`;
      inner += `<div style="margin-top:8px"><input type="text" id="${id}_new_opt" placeholder="–î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é..." /><button class="button" id="${id}_add">–î–æ–±–∞–≤–∏—Ç—å</button></div>`;
    } else if(control.type === 'member'){
      inner += `<input type="text" id="${id}" placeholder="ID —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–ª–∏ @nickname" />`;
    } else if(control.type === 'role'){
      inner += `<select id="${id}"><option value="">-- –≤—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å --</option></select><div style="margin-top:8px"><input type="text" id="${id}_new" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å (–∏–º—è –∏–ª–∏ ID)" /><button class="button" id="${id}_add">–î–æ–±–∞–≤–∏—Ç—å</button></div>`;
    } else {
      inner += `<input type="text" id="${id}" />`;
    }
    inner += `<div style="display:flex;gap:8px;margin-top:10px"><button class="button button-primary" data-save-setting="${escapeHtml(id)}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><div class="small muted" id="${id}_status"></div></div>`;
    el.innerHTML = inner; container.appendChild(el);

    // attach dynamic handlers for select/role add
    if(control.type === 'select'){
      setTimeout(()=>{
        document.getElementById(`${id}_add`)?.addEventListener('click', ()=>{
          const val = document.getElementById(`${id}_new_opt`).value.trim(); if(!val) return; const sel = document.getElementById(id); const op = document.createElement('option'); op.textContent = val; sel.appendChild(op); document.getElementById(`${id}_new_opt`).value = '';
        });
      },0);
    }
    if(control.type === 'role'){
      setTimeout(()=>{
        document.getElementById(`${id}_add`)?.addEventListener('click', ()=>{
          const val = document.getElementById(`${id}_new`).value.trim(); if(!val) return; const sel = document.getElementById(id); const op = document.createElement('option'); op.textContent = val; op.value = val; sel.appendChild(op); document.getElementById(`${id}_new`).value = '';
        });
      },0);
    }
    // save handler
    setTimeout(()=>{
      document.querySelector(`[data-save-setting="${escapeHtml(id)}"]`)?.addEventListener('click', async ()=>{
        try{
          const saveBtn = document.querySelector(`[data-save-setting="${escapeHtml(id)}"]`);
          saveBtn.disabled = true; saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';
          let value;
          if(control.type === 'boolean') value = document.getElementById(id).checked;
          else if(control.type === 'select') value = Array.from(document.getElementById(id).options).map(o=>o.value||o.textContent);
          else value = document.getElementById(id).value;
          await sendSetting(guild.id, tabKey, id, value);
          document.getElementById(`${id}_status`).textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
          setTimeout(()=>{ if(document.getElementById(`${id}_status`)) document.getElementById(`${id}_status`).textContent = ''; },2000);
          saveBtn.disabled = false; saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }catch(e){ console.warn(e); if(document.getElementById(`${id}_status`)) document.getElementById(`${id}_status`).textContent = '–û—à–∏–±–∫–∞'; const saveBtn = document.querySelector(`[data-save-setting="${escapeHtml(id)}"]`); if(saveBtn){ saveBtn.disabled=false; saveBtn.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; } }
      });
    },0);
  });
}

/* search filter */
function filterGuildsOnPage(q){ q = (q||'').toLowerCase().trim(); document.querySelectorAll('.guild-card').forEach(card=>{ const title = (card.querySelector('h3')?.textContent || '').toLowerCase(); const meta = (card.querySelector('.guild-meta')?.textContent || '').toLowerCase(); const gid = (card.dataset.guildId || '').toLowerCase(); if(!q || title.includes(q) || meta.includes(q) || gid.includes(q)) card.style.display = ''; else card.style.display = 'none'; }); }

/* MAIN renderApp */
async function renderApp(forceReload = false){ setTheme(getTheme()); const root = document.getElementById('root'); try{ const auth = await initAuth(); if(!auth.logged){ root.innerHTML = renderLoginPage(); attachGlobalEvents(); return; }

    const hash = (location.hash || '#/guilds').replace('#',''); const [_, route, guildId] = hash.split('/');

    if(route === 'guild' && guildId){
      // load guilds to find guild info and permissions
      let guilds = [];
      try{ guilds = await loadGuilds(); }catch(err){ console.warn('loadGuilds failed',err); location.hash = '#/guilds'; renderApp(); return; }
      const guild = guilds.find(g=>String(g.id) === String(guildId));
      if(!guild || !guild.botPresent || !guild.isAdmin){
        // redirect to guilds if not allowed or bot not present
        alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –±–æ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
        location.hash = '#/guilds'; renderApp(); return;
      }
      root.innerHTML = renderGuildPanelPage(auth.user, guild);
      attachGlobalEvents(); attachPanelEvents(guild);
      return;
    }

    // default: guilds page
    root.innerHTML = `${topBar(auth.user)}<main class="layout"><div class="controls-row"><div class="search"><input id="guildSearch" type="text" placeholder="–ü–æ–∏—Å–∫ –≥–∏–ª—å–¥–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ ID..." value="${escapeHtml(sessionStorage.getItem('guild_search')||'')}" /><button id="refreshBtn" class="button">–û–±–Ω–æ–≤–∏—Ç—å</button></div><div class="small-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div><section class="grid guild-grid"><div class="card empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div></section></main>`;
    document.getElementById('refreshBtn')?.addEventListener('click', ()=>renderApp(true)); document.getElementById('guildSearch')?.addEventListener('input', (e)=>{ sessionStorage.setItem('guild_search', e.target.value); }); attachGlobalEvents();

    // fetch guilds
    let guilds = [];
    try{ guilds = await loadGuilds(); }catch(err){ const hint = err.hint || {}; const hintText = hint && hint.reason === 'no_oauth_tokens' ? '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –Ω–∞–∂–º–∏—Ç–µ –í–æ–π—Ç–∏' : (typeof hint === 'object' ? JSON.stringify(hint) : String(hint)); root.innerHTML = `${topBar(auth.user)}<main class="layout"><div class="controls-row"><div class="search"><input id="guildSearch" type="text" placeholder="–ü–æ–∏—Å–∫ –≥–∏–ª—å–¥–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ ID..." value="${escapeHtml(sessionStorage.getItem('guild_search')||'')}" /><button id="refreshBtn" class="button">–û–±–Ω–æ–≤–∏—Ç—å</button></div></div><div class="card" style="color:var(--danger);margin-bottom:12px">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∏–ª—å–¥–∏–π: ${escapeHtml(err.status + ' ' + hintText)}<div style="margin-top:8px"><a href="${API_BASE}/login"><button class="button button-primary">–ü–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button></a></div></div></main>`; attachGlobalEvents(); document.getElementById('refreshBtn')?.addEventListener('click', ()=>renderApp(true)); return; }

    const searchVal = sessionStorage.getItem('guild_search') || '';
    root.innerHTML = renderGuildsPage(auth.user, guilds, searchVal);
    attachGlobalEvents(); attachGuildsPageEvents(); if(searchVal) filterGuildsOnPage(searchVal);

  }catch(e){ root.innerHTML = `<main class="layout"><section class="card"><h2>–û—à–∏–±–∫–∞</h2><pre>${escapeHtml(e && e.message ? e.message : String(e))}</pre></section></main>`; }
}

window.addEventListener('hashchange',()=>renderApp());
window.addEventListener('storage',()=>setTheme(getTheme()));
renderApp();
</script>
</body>
</html>